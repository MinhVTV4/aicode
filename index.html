<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Version Control AI Canvas</title>
    
    <!-- Google Font: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* CSS tùy chỉnh để giao diện đẹp hơn */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* bg-gray-100 */
            color: #374151; /* text-gray-700 */
        }
        /* Hiệu ứng khi di chuột vào nút */
        button {
            transition: all 0.3s ease;
        }
        button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        /* Kiểu cho các mục trong danh sách */
        .list-item {
            transition: all 0.2s ease;
        }
        .list-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .list-item.selected {
             background-color: #dbeafe; /* blue-100 */
             border-left: 4px solid #3b82f6; /* blue-500 */
        }
        /* Biểu tượng tải */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-left-color: #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* CSS cho Modal xem trước */
        #previewModal iframe {
            width: 100%;
            height: 80vh;
            border: 1px solid #e5e7eb; /* gray-200 */
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Phần Header -->
    <header class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4 shadow-lg flex justify-between items-center">
        <h1 class="text-3xl font-bold">Version Control AI Canvas</h1>
        <div id="authStatus" class="flex items-center space-x-4">
            <span id="userEmailDisplay" class="text-lg font-medium hidden"></span>
            <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 hidden">
                Đăng xuất
            </button>
        </div>
    </header>

    <!-- Phần Đăng nhập / Đăng ký -->
    <div id="authSection" class="flex-grow flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-3xl font-bold mb-6 text-center text-gray-800">Đăng nhập / Đăng ký</h2>
            <div class="mb-4">
                <label for="emailInput" class="block text-gray-700 text-sm font-bold mb-2">Email:</label>
                <input type="email" id="emailInput" placeholder="your@example.com" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500">
            </div>
            <div class="mb-6">
                <label for="passwordInput" class="block text-gray-700 text-sm font-bold mb-2">Mật khẩu:</label>
                <input type="password" id="passwordInput" placeholder="********" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500">
            </div>
            <div class="flex flex-col sm:flex-row gap-4">
                <button id="loginBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 flex-grow">
                    Đăng nhập
                </button>
                <button id="registerBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 flex-grow">
                    Đăng ký
                </button>
            </div>
            <p class="text-red-500 text-sm mt-4 text-center" id="authErrorMsg"></p>
        </div>
    </div>

    <!-- Nội dung chính của ứng dụng (Ẩn cho đến khi đăng nhập) -->
    <main id="mainAppContent" class="flex-grow container mx-auto p-4 grid grid-cols-1 lg:grid-cols-12 gap-6 hidden">
        
        <!-- Cột trái: Danh sách ứng dụng -->
        <section class="bg-white p-6 rounded-lg shadow-md col-span-1 lg:col-span-3 flex flex-col">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Applications</h2>
            <button id="addNewAppBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 mb-4 w-full">
                Add New Application
            </button>
            <div class="my-4">
                <input type="text" id="searchInput" placeholder="Tìm kiếm ứng dụng..." class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500">
            </div>
            <div id="applicationsList" class="space-y-3 flex-grow overflow-y-auto pr-2">
                <div class="text-gray-500 text-center py-4">Loading applications...</div>
            </div>
        </section>

        <!-- Cột giữa: Danh sách phiên bản -->
        <section class="bg-white p-6 rounded-lg shadow-md col-span-1 lg:col-span-3 flex flex-col">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Versions for <span id="currentAppName" class="font-bold text-blue-600">No App Selected</span></h2>
            <div id="versionsList" class="space-y-3 flex-grow overflow-y-auto pr-2">
                <div class="text-gray-500 text-center py-4">Select an application to see versions.</div>
            </div>
        </section>

        <!-- Cột phải: AI Canvas -->
        <section class="bg-white p-6 rounded-lg shadow-md col-span-1 lg:col-span-6 flex flex-col">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">AI Canvas</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="fileNameInput" class="block text-gray-700 text-sm font-bold mb-2">Tên tệp:</label>
                    <input type="text" id="fileNameInput" placeholder="e.g., index.html" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700">
                </div>
                <div>
                    <label for="versionNotesInput" class="block text-gray-700 text-sm font-bold mb-2">Ghi chú phiên bản:</label>
                    <input type="text" id="versionNotesInput" placeholder="e.g., 'Refactored with AI'" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700">
                </div>
            </div>

            <div class="flex-grow flex flex-col mb-4">
                <label for="mainCodeEditor" class="block text-gray-700 text-sm font-bold mb-2">Trình soạn thảo:</label>
                <textarea id="mainCodeEditor" class="flex-grow shadow-inner appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 font-mono text-sm" placeholder="Chọn một tệp, hoặc yêu cầu AI tạo code mới..."></textarea>
            </div>
            
            <div class="bg-gray-50 p-4 rounded-lg border">
                 <label for="aiPromptInput" class="block text-gray-700 text-sm font-bold mb-2">Yêu cầu cho AI:</label>
                 <textarea id="aiPromptInput" rows="3" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700" placeholder="e.g., 'Thêm bình luận cho hàm này' hoặc 'Tạo một nút bấm màu đỏ'"></textarea>
                 <button id="sendToAIButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 mt-3 w-full flex items-center justify-center gap-2">
                    <span id="aiButtonText">Gửi tới AI</span>
                    <div id="aiButtonSpinner" class="spinner hidden"></div>
                </button>
            </div>

            <!-- NÚT HÀNH ĐỘNG -->
            <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
                 <button id="saveVersionBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 w-full">
                    Lưu nội dung Editor thành phiên bản mới
                </button>
                <!-- NÚT XEM TRƯỚC MỚI -->
                <button id="previewBtn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 w-full">
                    Xem trước mã
                </button>
            </div>

             <h3 class="text-xl font-semibold mt-6 mb-3 text-gray-800">Tệp trong phiên bản đã chọn:</h3>
            <div id="versionFilesList" class="space-y-2 max-h-48 overflow-y-auto pr-2 border p-3 rounded-lg bg-gray-50">
                <div class="text-gray-500 text-center py-2">Chọn một phiên bản để xem các tệp của nó.</div>
            </div>
        </section>
    </main>

    <!-- Hộp thông báo tùy chỉnh -->
    <div id="messageBox" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg hidden z-50 transition-opacity duration-300 opacity-0">
        <span id="messageContent"></span>
    </div>

    <!-- Modal để thêm ứng dụng mới -->
    <div id="addNewAppModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-2xl font-bold mb-6 text-gray-800">Add New Application</h3>
            <div class="mb-4">
                <label for="newAppNameInput" class="block text-gray-700 text-sm font-bold mb-2">Application Name:</label>
                <input type="text" id="newAppNameInput" placeholder="e.g., 'My Blog App'" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500">
            </div>
            <div class="flex justify-end gap-4">
                <button id="cancelNewAppBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">Cancel</button>
                <button id="confirmNewAppBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Add Application</button>
            </div>
        </div>
    </div>

    <!-- MODAL XEM TRƯỚC MỚI -->
    <div id="previewModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-4xl flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-xl font-semibold">Bản xem trước</h3>
                <button id="closePreviewBtn" class="text-gray-500 hover:text-gray-800 text-3xl font-bold">&times;</button>
            </div>
            <div class="p-4">
                <iframe id="previewFrame" title="Preview Content"></iframe>
            </div>
        </div>
    </div>


    <!-- Firebase SDK và script tùy chỉnh -->
    <script type="module">
        // Import các module cần thiết từ Firebase (sử dụng phiên bản 12.0.0 như code gốc)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, getDocs, getDoc, onSnapshot, query, orderBy, setDoc, updateDoc, deleteDoc, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
        
        // **QUAY LẠI SỬ DỤNG FIREBASE AI SDK NHƯ CODE GỐC**
        import { getAI, getGenerativeModel, GoogleAIBackend } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-ai.js";

        // --- Cấu hình Firebase ---
        // LƯU Ý QUAN TRỌNG: Thay thế các giá trị dưới đây bằng cấu hình Firebase của chính bạn.
        const firebaseConfig = {
            apiKey: "AIzaSyD7I9ZKYFTc71tFMGA2lM72ykwDuwhEV0o",
            authDomain: "tudien-b2d17.firebaseapp.com",
            projectId: "tudien-b2d17",
            storageBucket: "tudien-b2d17.firebasestorage.app",
            messagingSenderId: "496472238606",
            appId: "1:496472238606:web:79769d3c38e546a27dea5f"
        };

        // --- Khởi tạo Firebase ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- Khởi tạo AI Model thông qua Firebase AI SDK ---
        let aiModel;
        try {
            const ai = getAI(app, { backend: new GoogleAIBackend() });
            aiModel = getGenerativeModel(ai, { model: "gemini-1.5-flash-latest" });
            console.log("Generative Model initialized successfully via Firebase AI SDK.");
        } catch (e) {
            console.error("Error initializing AI Model:", e);
            showMessage("Lỗi khởi tạo AI Model. Kiểm tra Console.", 5000);
        }

        // --- Biến toàn cục và tham chiếu DOM ---
        let currentAppId = null;
        let currentAppName = null;
        let currentVersionId = null; 
        let userId = null;
        let allApps = [];
        let chat = null; // **BIẾN MỚI: Lưu trữ phiên trò chuyện với AI**

        const applicationsList = document.getElementById('applicationsList');
        const versionsList = document.getElementById('versionsList');
        const currentAppNameSpan = document.getElementById('currentAppName');
        const saveVersionBtn = document.getElementById('saveVersionBtn');
        const addNewAppBtn = document.getElementById('addNewAppBtn');
        const addNewAppModal = document.getElementById('addNewAppModal');
        const newAppNameInput = document.getElementById('newAppNameInput');
        const confirmNewAppBtn = document.getElementById('confirmNewAppBtn');
        const cancelNewAppBtn = document.getElementById('cancelNewAppBtn');
        const messageBox = document.getElementById('messageBox');
        const messageContent = document.getElementById('messageContent');
        const authSection = document.getElementById('authSection');
        const mainAppContent = document.getElementById('mainAppContent');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userEmailDisplay = document.getElementById('userEmailDisplay');
        const authErrorMsg = document.getElementById('authErrorMsg');
        const versionFilesList = document.getElementById('versionFilesList');
        const searchInput = document.getElementById('searchInput'); 
        const fileNameInput = document.getElementById('fileNameInput');
        const versionNotesInput = document.getElementById('versionNotesInput');
        const mainCodeEditor = document.getElementById('mainCodeEditor');
        const aiPromptInput = document.getElementById('aiPromptInput');
        const sendToAIButton = document.getElementById('sendToAIButton');
        const aiButtonText = document.getElementById('aiButtonText');
        const aiButtonSpinner = document.getElementById('aiButtonSpinner');
        
        // THAM CHIẾU DOM CHO TÍNH NĂNG XEM TRƯỚC
        const previewBtn = document.getElementById('previewBtn');
        const previewModal = document.getElementById('previewModal');
        const closePreviewBtn = document.getElementById('closePreviewBtn');
        const previewFrame = document.getElementById('previewFrame');

        // --- Hàm tiện ích ---
        function showMessage(message, duration = 3000) {
            messageContent.textContent = message;
            messageBox.classList.remove('hidden', 'opacity-0');
            messageBox.classList.add('opacity-100');
            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                messageBox.classList.add('opacity-0');
                setTimeout(() => messageBox.classList.add('hidden'), 300);
            }, duration);
        }

        function showAuthError(message) {
            authErrorMsg.textContent = message;
        }

        // --- Xác thực Firebase ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                userEmailDisplay.textContent = user.email || "Anonymous";
                userEmailDisplay.classList.remove('hidden');
                logoutBtn.classList.remove('hidden');
                authSection.classList.add('hidden');
                mainAppContent.classList.remove('hidden');
                mainAppContent.classList.add('grid');
                loadApplications();
            } else {
                userId = null;
                userEmailDisplay.classList.add('hidden');
                logoutBtn.classList.add('hidden');
                authSection.classList.remove('hidden');
                mainAppContent.classList.add('hidden');
                mainAppContent.classList.remove('grid');
            }
        });

        // --- Các hàm xác thực ---
        const handleRegister = async () => {
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            if (!email || !password) return showAuthError("Vui lòng nhập email và mật khẩu.");
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showMessage("Đăng ký thành công!");
                authErrorMsg.textContent = '';
            } catch (error) {
                showAuthError(error.message);
            }
        };

        const handleLogin = async () => {
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            if (!email || !password) return showAuthError("Vui lòng nhập email và mật khẩu.");
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showMessage("Đăng nhập thành công!");
                authErrorMsg.textContent = '';
            } catch (error) {
                showAuthError("Email hoặc mật khẩu không đúng.");
            }
        };

        const handleLogout = () => signOut(auth).then(() => showMessage("Đã đăng xuất."));

        // --- Logic Firestore ---
        const getApplicationsCollectionRef = () => collection(db, `users/${userId}/applications`);
        const getVersionsCollectionRef = (appId) => collection(db, `users/${userId}/applications/${appId}/versions`);
        const getFilesCollectionRef = (appId, versionId) => collection(db, `users/${userId}/applications/${appId}/versions/${versionId}/files`);

        // **SỬA LỖI: Cập nhật hàm getFilesForVersion**
        const getFilesForVersion = async (appId, versionId) => {
            const files = new Map();
            let currentId = versionId;
            while (currentId) {
                const versionRef = doc(db, `users/${userId}/applications/${appId}/versions/${currentId}`);
                const versionSnap = await getDoc(versionRef);
                if (!versionSnap.exists()) break;
                const versionData = versionSnap.data();
                
                // Lấy tất cả các tệp trong subcollection 'files'
                const filesQuery = query(getFilesCollectionRef(appId, currentId));
                const filesSnapshot = await getDocs(filesQuery);
                filesSnapshot.forEach(fileDoc => {
                    const fileData = fileDoc.data();
                    if (!files.has(fileData.filename)) {
                        files.set(fileData.filename, { ...fileData, id: fileDoc.id, versionId: currentId });
                    }
                });

                currentId = versionData.parentVersionId || null;
            }
            return files;
        };

        // --- Các hàm render giao diện ---
        const renderApplications = (appsToRender) => {
            applicationsList.innerHTML = '';
            if (appsToRender.length === 0) {
                applicationsList.innerHTML = '<div class="text-gray-500 text-center py-4">Chưa có ứng dụng nào.</div>';
                return;
            }
            appsToRender.forEach((appData, index) => {
                const appItem = document.createElement('div');
                appItem.id = `app-${appData.id}`;
                appItem.className = 'list-item bg-gray-100 hover:bg-blue-100 p-3 rounded-lg cursor-pointer transition duration-200 shadow-sm flex justify-between items-center';
                if (appData.id === currentAppId) appItem.classList.add('selected');
                appItem.innerHTML = `<span class="font-medium text-gray-700">${index + 1}. ${appData.name}</span>`;
                appItem.onclick = () => selectApplication(appData.id, appData.name);
                applicationsList.appendChild(appItem);
            });
        };

        const loadApplications = () => {
            if (!userId) return;
            const q = query(getApplicationsCollectionRef(), orderBy('createdAt', 'desc'));
            onSnapshot(q, (snapshot) => {
                allApps = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderApplications(allApps);
            }, (error) => console.error("Error loading applications:", error));
        };

        const selectApplication = (appId, appName) => {
            currentAppId = appId;
            currentAppName = appName;
            currentVersionId = null;
            chat = null; // Reset phiên chat khi chọn ứng dụng mới
            currentAppNameSpan.textContent = appName;
            document.querySelectorAll('#applicationsList > div').forEach(el => el.classList.remove('selected'));
            document.getElementById(`app-${appId}`)?.classList.add('selected');
            loadVersions(appId);
            mainCodeEditor.value = '';
            fileNameInput.value = '';
            versionNotesInput.value = '';
            versionFilesList.innerHTML = '<div class="text-gray-500 text-center py-2">Chọn một phiên bản để xem tệp.</div>';
        };

        const loadVersions = (appId) => {
            if (!userId || !appId) return;
            const q = query(getVersionsCollectionRef(appId), orderBy('timestamp', 'desc'));
            onSnapshot(q, (snapshot) => {
                versionsList.innerHTML = '';
                if (snapshot.empty) {
                    versionsList.innerHTML = '<div class="text-gray-500 text-center py-4">Chưa có phiên bản nào.</div>';
                    return;
                }
                snapshot.forEach(doc => {
                    const version = doc.data();
                    const versionItem = document.createElement('div');
                    versionItem.id = `version-${doc.id}`;
                    versionItem.className = 'list-item bg-gray-100 hover:bg-blue-100 p-3 rounded-lg cursor-pointer transition duration-200 shadow-sm';
                    if (doc.id === currentVersionId) versionItem.classList.add('selected');
                    // Sử dụng Date.now() nên không cần toDate()
                    const date = new Date(version.timestamp).toLocaleString();
                    versionItem.innerHTML = `
                        <p class="font-medium text-gray-700">Phiên bản: ${version.versionIndex || 'N/A'}</p>
                        <p class="text-sm text-gray-500">${version.notes || 'Không có ghi chú'}</p>
                        <p class="text-xs text-gray-400">${date}</p>`;
                    versionItem.onclick = () => selectVersion(appId, doc.id);
                    versionsList.appendChild(versionItem);
                });
            });
        };

        const selectVersion = async (appId, versionId) => {
            currentVersionId = versionId;
            chat = null; // Reset phiên chat khi chọn phiên bản mới
            document.querySelectorAll('#versionsList > div').forEach(el => el.classList.remove('selected'));
            document.getElementById(`version-${versionId}`)?.classList.add('selected');
            versionFilesList.innerHTML = '<div class="text-gray-500 text-center py-2">Đang tải tệp...</div>';
            try {
                const filesMap = await getFilesForVersion(appId, versionId);
                versionFilesList.innerHTML = '';
                if (filesMap.size > 0) {
                    // Sắp xếp file theo tên
                    const sortedFiles = Array.from(filesMap.values()).sort((a, b) => a.filename.localeCompare(b.filename));
                    sortedFiles.forEach(fileData => {
                        const fileItem = document.createElement('div');
                        fileItem.className = 'list-item bg-gray-100 hover:bg-blue-100 p-2 rounded-lg cursor-pointer transition duration-200 shadow-sm text-sm';
                        fileItem.textContent = fileData.filename;
                        fileItem.onclick = () => {
                            mainCodeEditor.value = fileData.content;
                            fileNameInput.value = fileData.filename;
                            showMessage(`Đã tải ${fileData.filename} vào trình soạn thảo.`);
                            chat = null; // Reset phiên chat khi tải tệp mới
                        };
                        versionFilesList.appendChild(fileItem);
                    });
                } else {
                    versionFilesList.innerHTML = '<div class="text-gray-500 text-center py-2">Không tìm thấy tệp nào.</div>';
                }
            } catch (error) {
                console.error("Error loading files for version:", error);
                versionFilesList.innerHTML = '<div class="text-red-500 text-center py-2">Lỗi khi tải tệp.</div>';
            }
        };

        // --- Logic AI Canvas (Sử dụng Firebase AI SDK với ngữ cảnh hội thoại) ---
        const callAI = async () => {
            if (!aiModel) {
                return showMessage("Mô hình AI chưa sẵn sàng.", 3000);
            }
            const userPrompt = aiPromptInput.value.trim();
            if (!userPrompt) return showMessage("Vui lòng nhập yêu cầu cho AI.");

            aiButtonText.textContent = 'Đang xử lý...';
            aiButtonSpinner.classList.remove('hidden');
            sendToAIButton.disabled = true;

            try {
                // Nếu chưa có phiên chat, hãy bắt đầu một phiên mới với ngữ cảnh hiện tại
                if (!chat) {
                    const currentCode = mainCodeEditor.value;
                    const history = [
                        {
                            role: "user",
                            parts: [{ text: `Bạn là một trợ lý lập trình chuyên nghiệp. Mã nguồn hiện tại để làm việc là:\n---\n${currentCode}` }],
                        },
                        {
                            role: "model",
                            parts: [{ text: "Đã hiểu. Tôi đã nhận được mã nguồn. Bạn có yêu cầu gì?" }],
                        }
                    ];
                    chat = aiModel.startChat({ history });
                }

                const result = await chat.sendMessage(userPrompt);
                const response = result.response;
                let text = response.text();
                text = text.replace(/^```[\w-]*\n/, '').replace(/\n```$/, ''); // Dọn dẹp markdown
                
                mainCodeEditor.value = text; // Cập nhật trình soạn thảo với mã mới
                aiPromptInput.value = ''; // Xóa yêu cầu sau khi gửi
                showMessage("AI đã cập nhật mã trong trình soạn thảo.");

            } catch (error) {
                console.error("Error calling AI via Firebase:", error);
                showMessage(`Lỗi khi gọi AI: ${error.message}`, 5000);
                chat = null; // Reset phiên chat nếu có lỗi
            } finally {
                aiButtonText.textContent = 'Gửi tới AI';
                aiButtonSpinner.classList.add('hidden');
                sendToAIButton.disabled = false;
            }
        };

        // --- Các hàm hành động ---
        // **SỬA LỖI: Cập nhật hàm saveVersion**
        const saveVersion = async () => {
            if (!userId || !currentAppId) return showMessage('Vui lòng chọn một ứng dụng.');
            const filename = fileNameInput.value.trim();
            const content = mainCodeEditor.value;
            if (!filename || !content) return showMessage(`Tên tệp và nội dung không được để trống.`);

            try {
                const versionsQuery = query(getVersionsCollectionRef(currentAppId));
                const versionsSnapshot = await getDocs(versionsQuery);
                const newVersionIndex = versionsSnapshot.size + 1;

                // Sử dụng addDoc để tạo phiên bản mới và lấy ID
                const newVersionRef = await addDoc(getVersionsCollectionRef(currentAppId), {
                    versionIndex: newVersionIndex,
                    notes: versionNotesInput.value.trim() || 'Không có ghi chú',
                    timestamp: Date.now(), // Quay về dùng Date.now() cho ổn định
                    parentVersionId: currentVersionId 
                });

                // Sử dụng addDoc để thêm tệp mới vào subcollection 'files'
                await addDoc(getFilesCollectionRef(currentAppId, newVersionRef.id), {
                    filename,
                    content
                });
                
                showMessage('Phiên bản mới đã được lưu thành công!');
                mainCodeEditor.value = '';
                fileNameInput.value = '';
                versionNotesInput.value = '';
                aiPromptInput.value = '';
            } catch (error) {
                console.error("Error saving version:", error);
                showMessage('Lưu phiên bản thất bại.', 5000);
            }
        };

        const addNewApplication = async () => {
            if (!userId) return;
            const appName = newAppNameInput.value.trim();
            if (!appName) return showMessage('Tên ứng dụng không được để trống.');
            try {
                await addDoc(getApplicationsCollectionRef(), { 
                    name: appName, 
                    createdAt: Date.now() // Dùng Date.now()
                });
                showMessage(`Ứng dụng "${appName}" đã được thêm!`);
                hideAddNewAppModal();
            } catch (error) {
                console.error("Error adding new application:", error);
                showMessage('Thêm ứng dụng mới thất bại.', 5000);
            }
        };
        
        const showAddNewAppModal = () => {
            if (!userId) return showMessage('Vui lòng đăng nhập để thêm ứng dụng.');
            newAppNameInput.value = '';
            addNewAppModal.classList.remove('hidden');
        };

        const hideAddNewAppModal = () => addNewAppModal.classList.add('hidden');

        // --- LOGIC CHO TÍNH NĂNG XEM TRƯỚC ---
        const showPreview = () => {
            const codeToPreview = mainCodeEditor.value;
            if (!codeToPreview) {
                showMessage("Không có mã trong trình soạn thảo để xem trước.", 3000);
                return;
            }
            // Sử dụng srcdoc để đưa mã HTML vào iframe một cách an toàn
            previewFrame.srcdoc = codeToPreview;
            previewModal.classList.remove('hidden');
        };

        const closePreview = () => {
            previewModal.classList.add('hidden');
            // Xóa nội dung iframe để giải phóng bộ nhớ
            previewFrame.srcdoc = '';
        };

        // --- Gắn các sự kiện ---
        saveVersionBtn.addEventListener('click', saveVersion);
        addNewAppBtn.addEventListener('click', showAddNewAppModal);
        confirmNewAppBtn.addEventListener('click', addNewApplication);
        cancelNewAppBtn.addEventListener('click', hideAddNewAppModal);
        loginBtn.addEventListener('click', handleLogin);
        registerBtn.addEventListener('click', handleRegister);
        logoutBtn.addEventListener('click', handleLogout);
        sendToAIButton.addEventListener('click', callAI);
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredApps = allApps.filter(app => app.name.toLowerCase().includes(searchTerm));
            renderApplications(filteredApps);
        });

        // Gắn sự kiện cho các nút xem trước
        previewBtn.addEventListener('click', showPreview);
        closePreviewBtn.addEventListener('click', closePreview);

    </script>
</body>
</html>
