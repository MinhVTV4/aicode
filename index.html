<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Version Control AI Canvas with Monaco Editor</title>
    
    <!-- Google Font: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* CSS tùy chỉnh để giao diện đẹp hơn và theo Material Design */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #424242;
        }
        button {
            transition: all 0.3s cubic-bezier(.25,.8,.25,1);
            box-shadow: 0 3px 1px -2px rgba(0,0,0,.2), 0 2px 2px 0 rgba(0,0,0,.14), 0 1px 5px 0 rgba(0,0,0,.12);
        }
        button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 5px 5px -3px rgba(0,0,0,.2), 0 8px 10px 1px rgba(0,0,0,.14), 0 3px 14px 2px rgba(0,0,0,.12);
        }
        button:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 2px 4px -1px rgba(0,0,0,.2), 0 4px 5px 0 rgba(0,0,0,.14), 0 1px 10px 0 rgba(0,0,0,.12);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
        }
        .list-item {
            transition: all 0.2s cubic-bezier(.25,.8,.25,1);
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 2px 0 rgba(0,0,0,.14), 0 3px 1px -2px rgba(0,0,0,.12), 0 1px 5px 0 rgba(0,0,0,.2);
        }
        .list-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 5px 0 rgba(0,0,0,.14), 0 1px 10px 0 rgba(0,0,0,.12), 0 2px 4px -1px rgba(0,0,0,.2);
            border-color: #90caf9;
        }
        .list-item.selected {
             background-color: #e3f2fd;
             border-left: 4px solid #1976d2;
             border-color: #90caf9;
             box-shadow: 0 2px 2px 0 rgba(0,0,0,.14), 0 3px 1px -2px rgba(0,0,0,.12), 0 1px 5px 0 rgba(0,0,0,.2);
        }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.4);
            border-left-color: #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        #previewModal iframe {
            width: 100%;
            height: 80vh;
            border: 1px solid #e0e0e0;
            border-radius: 0.5rem;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.06);
        }
        #previewFrameContainer {
            transition: max-width 0.3s ease-in-out;
            max-width: 100%;
            width: 100%;
        }
        #previewFrameContainer.mobile-view {
            max-width: 375px;
        }
        #previewModalContent {
            transition: max-width 0.3s ease-in-out, width 0.3s ease-in-out;
        }
        #previewModalContent.desktop-mode-active {
            max-width: 90vw;
            width: 90vw;
        }
        /* Monaco Editor Container Style */
        #monacoEditorContainer {
            min-height: 400px; /* Tăng chiều cao tối thiểu */
            height: 50vh; /* Chiều cao linh hoạt */
            border: 1px solid #e0e0e0;
            border-radius: 0.5rem;
            overflow: hidden; /* Cần thiết cho Monaco Editor */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-indigo-700 text-white p-4 shadow-md flex justify-between items-center z-40">
        <h1 class="text-3xl font-bold">Version Control AI Canvas</h1>
        <div id="authStatus" class="flex items-center space-x-4">
            <span id="userEmailDisplay" class="text-lg font-medium hidden"></span>
            <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 hidden">
                Đăng xuất
            </button>
        </div>
    </header>

    <!-- Auth Section -->
    <div id="authSection" class="flex-grow flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
            <h2 class="text-3xl font-bold mb-6 text-center text-gray-800">Đăng nhập / Đăng ký</h2>
            <div class="mb-4">
                <label for="emailInput" class="block text-gray-700 text-base font-bold mb-2">Email:</label>
                <input type="email" id="emailInput" placeholder="your@example.com" class="shadow-sm border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-500">
            </div>
            <div class="mb-6">
                <label for="passwordInput" class="block text-gray-700 text-base font-bold mb-2">Mật khẩu:</label>
                <input type="password" id="passwordInput" placeholder="********" class="shadow-sm border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-500">
            </div>
            <div class="flex flex-col sm:flex-row gap-4">
                <button id="loginBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-5 rounded-lg shadow-md flex-grow">
                    Đăng nhập
                </button>
                <button id="registerBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-5 rounded-lg shadow-md flex-grow">
                    Đăng ký
                </button>
            </div>
            <p class="text-red-500 text-sm mt-4 text-center" id="authErrorMsg"></p>
        </div>
    </div>

    <!-- Main App Content -->
    <main id="mainAppContent" class="flex-grow container mx-auto p-4 grid grid-cols-1 lg:grid-cols-12 gap-6 hidden">
        
        <!-- Left Column: Applications List -->
        <section class="bg-white p-6 rounded-lg shadow-md col-span-1 lg:col-span-2 flex flex-col border border-gray-200">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Applications</h2>
            <button id="addNewAppBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-5 rounded-lg shadow-md mb-4 w-full">
                Add New Application
            </button>
            <div class="my-4">
                <input type="text" id="searchInput" placeholder="Tìm kiếm ứng dụng..." class="shadow-sm border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-500">
            </div>
            <div id="applicationsList" class="space-y-3 flex-grow overflow-y-auto pr-2">
                <div class="text-gray-500 text-center py-4">Loading applications...</div>
            </div>
        </section>

        <!-- Middle Column: Versions List -->
        <section class="bg-white p-6 rounded-lg shadow-md col-span-1 lg:col-span-2 flex flex-col border border-gray-200">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Versions for <span id="currentAppName" class="font-bold text-blue-600">No App Selected</span></h2>
            <button id="showDeletedVersionsBtn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-5 rounded-lg shadow-md mb-4 w-full">
                Xem phiên bản đã xóa
            </button>
            <div id="versionsList" class="space-y-3 flex-grow overflow-y-auto pr-2">
                <div class="text-gray-500 text-center py-4">Select an application to see versions.</div>
            </div>
        </section>

        <!-- Right Column: AI Canvas -->
        <section class="bg-white p-8 rounded-xl shadow-xl col-span-1 lg:col-span-8 flex flex-col border border-gray-200">
            <h2 class="text-3xl font-bold mb-6 text-gray-800">AI Canvas</h2>
            
            <!-- Block 1: Files and Version Info -->
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mb-6">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">Tệp trong phiên bản đã chọn:</h3>
                <div id="versionFilesList" class="space-y-2 max-h-48 overflow-y-auto pr-2 border border-gray-300 p-3 rounded-lg bg-gray-50 mb-4">
                    <div class="text-gray-500 text-center py-2">Chọn một phiên bản để xem các tệp của nó.</div>
                </div>
                
                <!-- Nút THÊM TỆP MỚI -->
                <button id="addNewFileBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md mb-4 w-full" disabled>
                    Thêm Tệp Mới
                </button>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="fileNameInput" class="block text-gray-700 text-base font-bold mb-2">Tên tệp:</label>
                        <input type="text" id="fileNameInput" placeholder="e.g., index.html" class="shadow-sm border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-500" disabled>
                    </div>
                    <div>
                        <label for="versionNotesInput" class="block text-gray-700 text-base font-bold mb-2">Ghi chú phiên bản đã chọn:</label>
                        <div class="flex gap-2">
                            <input type="text" id="versionNotesInput" placeholder="Chưa chọn phiên bản" class="shadow-sm border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-500" disabled>
                            <button id="editVersionNotesBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-3 rounded-lg shadow-md flex-shrink-0" style="min-width: 80px;" disabled>Sửa</button>
                            <button id="saveEditedVersionNotesBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-3 rounded-lg shadow-md hidden flex-shrink-0" style="min-width: 80px;">Lưu</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Block 2: Code Editor (Monaco) -->
            <div class="flex-grow flex flex-col mb-6 bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                <div class="flex justify-between items-center mb-4">
                    <label for="monacoEditorContainer" class="block text-gray-700 text-base font-bold mb-0">Trình soạn thảo (Monaco):</label>
                    <button id="copyBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg shadow-md flex-shrink-0 text-sm">
                        Sao chép mã
                    </button>
                </div>
                <!-- Monaco Editor container -->
                <div id="monacoEditorContainer" class="rounded-lg shadow-inner"></div>
            </div>

            <!-- Block 3: AI Explanation -->
            <div class="mb-6 bg-white p-6 rounded-xl shadow-lg border border-gray-200 border-l-4 border-purple-600">
                <label for="aiExplanationBox" class="block text-gray-700 text-base font-bold mb-2">Giải thích từ AI:</label>
                <div id="aiExplanationBox" class="w-full h-32 p-4 bg-purple-50 border border-purple-200 rounded-lg overflow-y-auto text-sm text-gray-700 leading-relaxed">
                    <p class="text-gray-500">Phần giải thích của AI sẽ xuất hiện ở đây...</p>
                </div>
            </div>

            <!-- Block 4: Main Style Selection -->
            <div class="mb-6 bg-white p-6 rounded-xl shadow-lg border border-gray-200 border-l-4 border-blue-600">
                <label for="mainStyleSelect" class="block text-gray-700 text-base font-bold mb-2">Chọn Phong cách Chủ đạo cho AI:</label>
                <select id="mainStyleSelect" class="shadow-sm border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-500">
                     <option value="">Không có phong cách cụ thể (mặc định)</option>
                    <option value="Modern Minimalist">Hiện đại Tối giản (Modern Minimalist)</option>
                    <option value="Clean and Professional">Sạch sẽ và Chuyên nghiệp (Clean and Professional)</option>
                    <option value="Flat Design">Thiết kế phẳng (Flat Design)</option>
                    <option value="Material Design">Material Design (Google)</option>
                    <option value="Fluent Design">Fluent Design (Microsoft)</option>
                    <option value="Glassmorphism">Glassmorphism (Hiệu ứng kính mờ)</option>
                    <option value="Neumorphism">Neumorphism (Hiệu ứng nổi khối mềm)</option>
                    <option value="Brutalism">Brutalism (Thô ráp, ít trang trí)</option>
                    <option value="Dark Mode Aesthetic">Thẩm mỹ Chế độ Tối (Dark Mode Aesthetic)</option>
                    <option value="Gradient-focused">Tập trung Gradient</option>
                    <option value="Playful and Illustrative">Vui tươi và minh họa</option>
                    <option value="Retro/Vintage Modern">Retro/Vintage Hiện đại</option>
                    <option value="Skeuomorphic">Skeuomorphic (Mô phỏng vật lý)</option>
                    <option value="Futuristic Tech">Công nghệ Tương lai</option>
                </select>
            </div>
            
            <!-- Block 5: AI Prompt and Send Button -->
            <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-lg">
                 <label for="aiPromptInput" class="block text-gray-700 text-base font-bold mb-2">Yêu cầu cho AI:</label>
                 <textarea id="aiPromptInput" rows="3" class="shadow-sm border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-500" placeholder="e.g., 'Thêm bình luận cho hàm này' hoặc 'Tạo một nút bấm màu đỏ'"></textarea>
                 
                 <div class="mt-4">
                     <div class="flex items-center gap-2 mb-2">
                        <label class="block text-gray-700 text-sm font-bold">Gợi ý câu lệnh AI:</label>
                        <button id="toggleAiSuggestionsBtn" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 py-1 px-2 rounded-full">Ẩn</button>
                     </div>
                     <div id="aiPromptSuggestions" class="flex flex-wrap gap-2"></div>
                 </div>

                 <button id="sendToAIButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-5 rounded-lg shadow-md mt-4 w-full flex items-center justify-center gap-2">
                    <span id="aiButtonText">Gửi tới AI</span>
                    <div id="aiButtonSpinner" class="spinner hidden"></div>
                </button>
            </div>

            <!-- Block 6: Action Buttons -->
            <div class="mt-6 p-6 bg-white rounded-xl border border-gray-200 shadow-lg">
                <div class="mb-4">
                    <label for="newVersionNotesInput" class="block text-gray-700 text-base font-bold mb-2">Ghi chú cho phiên bản mới:</label>
                    <input type="text" id="newVersionNotesInput" placeholder="e.g., 'Refactored with AI'" class="shadow-sm border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-500">
                </div>
                 <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                     <button id="saveVersionBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-5 rounded-lg shadow-md w-full">
                        Lưu phiên bản mới
                    </button>
                    <button id="previewBtn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-5 rounded-lg shadow-md w-full">
                        Xem trước mã
                    </button>
                    <button id="softDeleteVersionBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-5 rounded-lg shadow-md w-full">
                        Xóa phiên bản
                    </button>
                </div>
            </div>
        </section>
    </main>

    <!-- MessageBox -->
    <div id="messageBox" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-xl hidden z-50 transition-opacity duration-300 opacity-0">
        <span id="messageContent"></span>
    </div>

    <!-- Modals (Add App, Edit App, Preview, Deleted Versions) -->
    <!-- Add New App Modal -->
    <div id="addNewAppModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-2xl font-bold mb-6 text-gray-800">Add New Application</h3>
            <div class="mb-4">
                <label for="newAppNameInput" class="block text-gray-700 text-base font-bold mb-2">Application Name:</label>
                <input type="text" id="newAppNameInput" placeholder="e.g., 'My Blog App'" class="shadow-sm border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-500">
            </div>
            <div class="flex justify-end gap-4">
                <button id="cancelNewAppBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">Cancel</button>
                <button id="confirmNewAppBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Add Application</button>
            </div>
        </div>
    </div>
    <!-- Edit App Modal -->
    <div id="editAppModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-2xl font-bold mb-6 text-gray-800">Sửa tên ứng dụng</h3>
            <div class="mb-4">
                <label for="editAppNameInput" class="block text-gray-700 text-base font-bold mb-2">Tên ứng dụng:</label>
                <input type="text" id="editAppNameInput" class="shadow-sm border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-500">
            </div>
            <div class="flex justify-end gap-4">
                <button id="cancelEditAppBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">Hủy</button>
                <button id="confirmEditAppBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Lưu</button>
            </div>
        </div>
    </div>
    <!-- Preview Modal -->
    <div id="previewModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div id="previewModalContent" class="bg-white rounded-lg shadow-2xl w-full max-w-4xl flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-gray-200">
                <h3 class="text-xl font-semibold">Bản xem trước</h3>
                <div class="flex space-x-2">
                    <button id="mobileViewBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-full transition duration-300 shadow-sm">
                        Chế độ di động
                    </button>
                    <button id="desktopViewBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-full transition duration-300 shadow-sm">
                        Chế độ desktop
                    </button>
                </div>
                <button id="closePreviewBtn" class="text-gray-500 hover:text-gray-800 text-3xl font-bold">&times;</button>
            </div>
            <div class="p-4 flex flex-col items-center">
                <div id="previewFrameContainer" class="w-full">
                    <iframe id="previewFrame" title="Preview Content"></iframe>
                </div>
            </div>
        </div>
    </div>
    <!-- Deleted Versions Modal -->
    <div id="deletedVersionsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <h3 class="text-2xl font-bold mb-6 text-gray-800">Phiên bản đã xóa</h3>
            <div id="deletedVersionsList" class="space-y-3 flex-grow overflow-y-auto pr-2">
                <div class="text-gray-500 text-center py-4">Đang tải các phiên bản đã xóa...</div>
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button id="closeDeletedVersionsModalBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">Đóng</button>
            </div>
        </div>
    </div>

    <!-- Monaco Editor Loader -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>

    <!-- Firebase SDK & Custom Script -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, getDocs, getDoc, onSnapshot, query, orderBy, setDoc, updateDoc, deleteDoc, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
        import { getAI, getGenerativeModel, GoogleAIBackend } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-ai.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyD7I9ZKYFTc71tFMGA2lM72ykwDuwhEV0o",
            authDomain: "tudien-b2d17.firebaseapp.com",
            projectId: "tudien-b2d17",
            storageBucket: "tudien-b2d17.firebasestorage.app",
            messagingSenderId: "496472238606",
            appId: "1:496472238606:web:79769d3c38e546a27dea5f"
        };

        // Firebase Initialization
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // AI Model Initialization
        let aiModel;
        try {
            const ai = getAI(app, { backend: new GoogleAIBackend() });
            aiModel = getGenerativeModel(ai, { model: "gemini-2.5-flash" });
            console.log("Generative Model initialized successfully via Firebase AI SDK.");
        } catch (e) {
            console.error("Error initializing AI Model:", e);
            showMessage("Lỗi khởi tạo AI Model. Kiểm tra Console.", 5000);
        }

        // Global variables and DOM references
        let currentAppId = null;
        let currentAppName = null;
        let currentVersionId = null; 
        let userId = null;
        let allApps = [];
        let chat = null;
        let currentVersionFiles = new Map(); // Stores files for the currently selected version
        let currentSelectedFilename = null; // Tracks which file is selected in the UI list and editor
        let monacoEditor; // Monaco Editor instance

        const elements = {
            authSection: document.getElementById('authSection'),
            mainAppContent: document.getElementById('mainAppContent'),
            emailInput: document.getElementById('emailInput'),
            passwordInput: document.getElementById('passwordInput'),
            loginBtn: document.getElementById('loginBtn'),
            registerBtn: document.getElementById('registerBtn'),
            logoutBtn: document.getElementById('logoutBtn'),
            userEmailDisplay: document.getElementById('userEmailDisplay'),
            authErrorMsg: document.getElementById('authErrorMsg'),
            applicationsList: document.getElementById('applicationsList'),
            versionsList: document.getElementById('versionsList'),
            currentAppNameSpan: document.getElementById('currentAppName'),
            searchInput: document.getElementById('searchInput'),
            versionFilesList: document.getElementById('versionFilesList'),
            fileNameInput: document.getElementById('fileNameInput'),
            versionNotesInput: document.getElementById('versionNotesInput'),
            editVersionNotesBtn: document.getElementById('editVersionNotesBtn'),
            saveEditedVersionNotesBtn: document.getElementById('saveEditedVersionNotesBtn'),
            newVersionNotesInput: document.getElementById('newVersionNotesInput'),
            monacoEditorContainer: document.getElementById('monacoEditorContainer'), // New
            aiPromptInput: document.getElementById('aiPromptInput'),
            sendToAIButton: document.getElementById('sendToAIButton'),
            aiButtonText: document.getElementById('aiButtonText'),
            aiButtonSpinner: document.getElementById('aiButtonSpinner'),
            aiExplanationBox: document.getElementById('aiExplanationBox'),
            aiPromptSuggestionsContainer: document.getElementById('aiPromptSuggestions'),
            toggleAiSuggestionsBtn: document.getElementById('toggleAiSuggestionsBtn'),
            mainStyleSelect: document.getElementById('mainStyleSelect'),
            saveVersionBtn: document.getElementById('saveVersionBtn'),
            copyBtn: document.getElementById('copyBtn'),
            previewBtn: document.getElementById('previewBtn'),
            softDeleteVersionBtn: document.getElementById('softDeleteVersionBtn'),
            messageBox: document.getElementById('messageBox'),
            messageContent: document.getElementById('messageContent'),
            addNewAppBtn: document.getElementById('addNewAppBtn'),
            addNewAppModal: document.getElementById('addNewAppModal'),
            newAppNameInput: document.getElementById('newAppNameInput'),
            confirmNewAppBtn: document.getElementById('confirmNewAppBtn'),
            cancelNewAppBtn: document.getElementById('cancelNewAppBtn'),
            editAppModal: document.getElementById('editAppModal'),
            editAppNameInput: document.getElementById('editAppNameInput'),
            confirmEditAppBtn: document.getElementById('confirmEditAppBtn'),
            cancelEditAppBtn: document.getElementById('cancelEditAppBtn'),
            previewModal: document.getElementById('previewModal'),
            closePreviewBtn: document.getElementById('closePreviewBtn'),
            previewFrame: document.getElementById('previewFrame'),
            mobileViewBtn: document.getElementById('mobileViewBtn'),
            desktopViewBtn: document.getElementById('desktopViewBtn'),
            previewFrameContainer: document.getElementById('previewFrameContainer'),
            previewModalContent: document.getElementById('previewModalContent'),
            showDeletedVersionsBtn: document.getElementById('showDeletedVersionsBtn'),
            deletedVersionsModal: document.getElementById('deletedVersionsModal'),
            deletedVersionsList: document.getElementById('deletedVersionsList'),
            closeDeletedVersionsModalBtn: document.getElementById('closeDeletedVersionsModalBtn'),
            addNewFileBtn: document.getElementById('addNewFileBtn'), // New element
        };

        const aiPromptSuggestions = [
            "Tạo cho tôi một ứng dụng web viết bằng html tích hợp js và css. Giao diện TailwindCss hiện đại. Nội dung của nó là:",
            "Thêm CSS để căn giữa nội dung trang và đặt màu nền là màu xanh nhạt (#e0f7fa).",
            "Viết JavaScript để khi click nút 'Click me' sẽ hiển thị thông báo 'Bạn đã click!'",
            "Giải thích đoạn mã HTML/CSS/JS này hoạt động như thế nào.",
            "Tối ưu hóa mã nguồn này để nó chạy nhanh hơn và dễ đọc hơn."
        ];

        // --- Monaco Editor Initialization ---
        function initializeEditor() {
            if (monacoEditor) return; // Already initialized
            require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' }});
            require(['vs/editor/editor.main'], function() {
                monacoEditor = monaco.editor.create(elements.monacoEditorContainer, {
                    value: '// Chọn một tệp hoặc yêu cầu AI tạo mã mới...',
                    language: 'plaintext',
                    theme: 'vs-light', // Changed from 'vs-dark' to 'vs-light'
                    automaticLayout: true,
                    fontSize: 14,
                    wordWrap: 'on',
                    minimap: { enabled: true },
                    scrollBeyondLastLine: false,
                });
            });
        }

        // --- Utility Functions ---
        function showMessage(message, duration = 3000) {
            elements.messageContent.textContent = message;
            elements.messageBox.classList.remove('hidden', 'opacity-0');
            elements.messageBox.classList.add('opacity-100');
            setTimeout(() => {
                elements.messageBox.classList.remove('opacity-100');
                elements.messageBox.classList.add('opacity-0');
                setTimeout(() => elements.messageBox.classList.add('hidden'), 300);
            }, duration);
        }

        function showAuthError(message) {
            elements.authErrorMsg.textContent = message;
        }

        function renderAiPromptSuggestions() {
            elements.aiPromptSuggestionsContainer.innerHTML = '';
            const fragment = document.createDocumentFragment();
            aiPromptSuggestions.forEach(prompt => {
                const button = document.createElement('button');
                button.textContent = prompt;
                button.className = 'bg-blue-100 hover:bg-blue-200 text-blue-800 text-xs py-1 px-3 rounded-full transition duration-200 cursor-pointer border border-blue-200 whitespace-nowrap overflow-hidden text-ellipsis shadow-sm';
                button.title = prompt;
                button.dataset.prompt = prompt;
                fragment.appendChild(button);
            });
            elements.aiPromptSuggestionsContainer.appendChild(fragment);
        }

        function toggleAiSuggestions() {
            elements.aiPromptSuggestionsContainer.classList.toggle('hidden');
            elements.toggleAiSuggestionsBtn.textContent = elements.aiPromptSuggestionsContainer.classList.contains('hidden') ? 'Hiện' : 'Ẩn';
        }

        // --- Firebase Auth ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                elements.userEmailDisplay.textContent = user.email || "Anonymous";
                elements.userEmailDisplay.classList.remove('hidden');
                elements.logoutBtn.classList.remove('hidden');
                elements.authSection.classList.add('hidden');
                elements.mainAppContent.classList.remove('hidden');
                elements.mainAppContent.classList.add('grid');
                initializeEditor(); // Initialize Monaco Editor after login
                loadApplications();
                renderAiPromptSuggestions();
            } else {
                userId = null;
                elements.userEmailDisplay.classList.add('hidden');
                elements.logoutBtn.classList.add('hidden');
                elements.authSection.classList.remove('hidden');
                elements.mainAppContent.classList.add('hidden');
                elements.mainAppContent.classList.remove('grid');
            }
        });

        const handleAuth = async (isRegister) => {
            const email = elements.emailInput.value.trim();
            const password = elements.passwordInput.value.trim();
            if (!email || !password) return showAuthError("Vui lòng nhập email và mật khẩu.");
            try {
                if (isRegister) await createUserWithEmailAndPassword(auth, email, password);
                else await signInWithEmailAndPassword(auth, email, password);
                showMessage(isRegister ? "Đăng ký thành công!" : "Đăng nhập thành công!");
                showAuthError('');
            } catch (error) {
                showAuthError(error.message);
            }
        };

        const handleLogout = () => signOut(auth).then(() => showMessage("Đã đăng xuất."));

        // --- Firestore Logic ---
        const getCollections = {
            applications: () => collection(db, `users/${userId}/applications`),
            versions: (appId) => collection(db, `users/${userId}/applications/${appId}/versions`),
            files: (appId, versionId) => collection(db, `users/${userId}/applications/${appId}/versions/${versionId}/files`)
        };

        const getFilesForVersion = async (appId, versionId) => {
            const files = new Map();
            let currentId = versionId;
            while (currentId) {
                const versionSnap = await getDoc(doc(db, `users/${userId}/applications/${appId}/versions/${currentId}`));
                if (!versionSnap.exists()) break;
                const versionData = versionSnap.data();
                
                const filesSnapshot = await getDocs(query(getCollections.files(appId, currentId)));
                filesSnapshot.forEach(fileDoc => {
                    const fileData = fileDoc.data();
                    if (!files.has(fileData.filename)) { // Only add if not already present from a newer version
                        files.set(fileData.filename, { ...fileData, id: fileDoc.id, versionId: currentId });
                    }
                });
                currentId = versionData.parentVersionId || null; // Traverse up to parent version
            }
            return files;
        };

        // --- UI Rendering ---
        const renderApplications = (appsToRender) => {
            elements.applicationsList.innerHTML = appsToRender.length === 0 
                ? '<div class="text-gray-500 text-center py-4">Chưa có ứng dụng nào.</div>'
                : '';
            const fragment = document.createDocumentFragment();
            appsToRender.forEach((appData, index) => {
                const appItem = document.createElement('div');
                appItem.className = `list-item bg-white p-3 rounded-lg cursor-pointer transition duration-200 shadow-sm flex justify-between items-center ${appData.id === currentAppId ? 'selected' : ''}`;
                appItem.dataset.appId = appData.id;
                appItem.dataset.appName = appData.name;
                appItem.innerHTML = `
                    <div class="flex-grow font-medium text-gray-700 overflow-hidden text-ellipsis whitespace-nowrap">${index + 1}. ${appData.name}</div>
                    <div class="flex-shrink-0 flex gap-0.5">
                        <button class="edit-app-btn bg-yellow-600 hover:bg-yellow-700 text-white text-xs font-bold py-0.5 px-1.5 rounded-md" title="Sửa">Sửa</button>
                        <button class="delete-app-btn bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-0.5 px-1.5 rounded-md" title="Xóa">Xóa</button>
                    </div>
                `;
                fragment.appendChild(appItem);
            });
            elements.applicationsList.appendChild(fragment);
        };

        const loadApplications = () => {
            if (!userId) return;
            const q = query(getCollections.applications(), orderBy('createdAt', 'desc'));
            onSnapshot(q, (snapshot) => {
                allApps = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderApplications(allApps);
            }, (error) => console.error("Error loading applications:", error));
        };

        // New function to render the files list
        const renderVersionFilesList = () => {
            elements.versionFilesList.innerHTML = '';
            if (currentVersionFiles.size > 0) {
                const sortedFiles = Array.from(currentVersionFiles.values()).sort((a, b) => a.filename.localeCompare(b.filename));
                const fragment = document.createDocumentFragment();
                sortedFiles.forEach(fileData => {
                    const fileItem = document.createElement('div');
                    // Check if this file is the one currently loaded in the editor (and thus selected in the UI)
                    const isSelected = fileData.filename === currentSelectedFilename; 
                    fileItem.className = `list-item bg-white p-2 rounded-lg cursor-pointer shadow-sm text-sm ${isSelected ? 'selected' : ''}`;
                    fileItem.textContent = fileData.filename;
                    fileItem.dataset.filename = fileData.filename;
                    fragment.appendChild(fileItem);
                });
                elements.versionFilesList.appendChild(fragment);
            } else {
                elements.versionFilesList.innerHTML = '<div class="text-gray-500 text-center py-2">Không tìm thấy tệp nào.</div>';
            }
        };

        const selectApplication = (appId, appName) => {
            currentAppId = appId;
            currentAppName = appName;
            currentVersionId = null;
            currentSelectedFilename = null; // Clear selected file when new app is selected
            chat = null;
            currentVersionFiles.clear();

            elements.currentAppNameSpan.textContent = appName;
            document.querySelectorAll('#applicationsList > div').forEach(el => el.classList.remove('selected'));
            document.querySelector(`#applicationsList [data-app-id="${appId}"]`)?.classList.add('selected');

            loadVersions(appId);
            if (monacoEditor) monacoEditor.setValue('// Chọn một tệp hoặc yêu cầu AI tạo mã mới...');
            elements.fileNameInput.value = '';
            elements.fileNameInput.disabled = true; // Disable until a file is selected or added
            elements.versionNotesInput.value = '';
            elements.versionNotesInput.disabled = true;
            elements.editVersionNotesBtn.classList.add('hidden'); // Hide edit button if no version selected
            elements.saveEditedVersionNotesBtn.classList.add('hidden');
            elements.newVersionNotesInput.value = '';
            
            // Disable buttons when no version is selected
            elements.addNewFileBtn.disabled = true; 
            elements.editVersionNotesBtn.disabled = true;

            renderVersionFilesList(); // Ensure file list is cleared/reset
            elements.aiExplanationBox.innerHTML = '<p class="text-gray-500">Phần giải thích của AI sẽ xuất hiện ở đây...</p>';
            elements.aiPromptInput.value = '';
        };

        const loadVersions = (appId) => {
            if (!userId || !appId) return;
            const q = query(getCollections.versions(appId), where('deleted', '!=', true), orderBy('timestamp', 'desc'));
            onSnapshot(q, (snapshot) => {
                elements.versionsList.innerHTML = snapshot.empty ? '<div class="text-gray-500 text-center py-4">Chưa có phiên bản nào.</div>' : '';
                const fragment = document.createDocumentFragment();
                snapshot.forEach(doc => {
                    const version = doc.data();
                    const versionItem = document.createElement('div');
                    versionItem.className = `list-item bg-white p-3 rounded-lg cursor-pointer shadow-sm ${doc.id === currentVersionId ? 'selected' : ''}`;
                    versionItem.innerHTML = `
                        <p class="font-medium text-gray-700">Phiên bản: ${version.versionIndex || 'N/A'}</p>
                        <p class="text-sm text-gray-500">${version.notes || 'Không có ghi chú'}</p>
                        <p class="text-xs text-gray-400">${new Date(version.timestamp).toLocaleString()}</p>`;
                    versionItem.dataset.versionId = doc.id;
                    fragment.appendChild(versionItem);
                });
                elements.versionsList.appendChild(fragment);
            });
        };

        const selectVersion = async (appId, versionId) => {
            currentVersionId = versionId;
            currentSelectedFilename = null; // Clear previous file selection when new version is selected
            chat = null;
            elements.aiPromptInput.value = '';
            document.querySelectorAll('#versionsList > div').forEach(el => el.classList.remove('selected'));
            document.querySelector(`#versionsList [data-version-id="${versionId}"]`)?.classList.add('selected');
            elements.aiExplanationBox.innerHTML = '<p class="text-gray-500">Phần giải thích của AI sẽ xuất hiện ở đây...</p>';
            if (monacoEditor) monacoEditor.setValue('// Chọn một tệp hoặc yêu cầu AI tạo mã mới...');
            elements.fileNameInput.value = ''; // Clear filename input
            elements.fileNameInput.disabled = false; // Enable filename input now that a version is selected

            // Enable buttons when a version is selected
            elements.addNewFileBtn.disabled = false;
            elements.editVersionNotesBtn.classList.remove('hidden'); // Show edit button
            elements.editVersionNotesBtn.disabled = false; // Enable edit notes button
            elements.saveEditedVersionNotesBtn.classList.add('hidden'); // Ensure save edited notes is hidden

            try {
                const versionSnap = await getDoc(doc(db, `users/${userId}/applications/${appId}/versions/${versionId}`));
                elements.versionNotesInput.value = versionSnap.exists() ? (versionSnap.data().notes || 'Không có ghi chú') : 'Phiên bản không tồn tại.';
                elements.versionNotesInput.disabled = true;
                elements.newVersionNotesInput.value = '';

                currentVersionFiles = await getFilesForVersion(appId, versionId);
                renderVersionFilesList(); // Use the new rendering function
                
            } catch (error) {
                console.error("Error loading version details:", error);
                elements.versionFilesList.innerHTML = '<div class="text-red-500">Lỗi khi tải tệp.</div>';
            }
        };

        const loadFileIntoEditor = (filename) => {
            if (!monacoEditor) return;
            const fileData = currentVersionFiles.get(filename);
            if (fileData) {
                currentSelectedFilename = filename; // Update the globally selected file
                elements.fileNameInput.value = fileData.filename;
                monacoEditor.setValue(fileData.content);
                
                let lang = 'plaintext';
                if (filename.endsWith('.html')) lang = 'html';
                else if (filename.endsWith('.css')) lang = 'css';
                else if (filename.endsWith('.js')) lang = 'javascript';
                else if (filename.endsWith('.json')) lang = 'json';
                else if (filename.endsWith('.md')) lang = 'markdown';
                
                monaco.editor.setModelLanguage(monacoEditor.getModel(), lang);
                
                showMessage(`Đã tải ${fileData.filename} vào trình soạn thảo.`);
                chat = null;
                elements.aiExplanationBox.innerHTML = '<p class="text-gray-500">Phần giải thích của AI sẽ xuất hiện ở đây...</p>';
                renderVersionFilesList(); // Re-render to update the selected state in the list
            }
        };

        // --- AI Logic ---
        const callAI = async () => {
            if (!aiModel || !monacoEditor) return showMessage("Mô hình AI hoặc trình soạn thảo chưa sẵn sàng.");
            const userPrompt = elements.aiPromptInput.value.trim();
            if (!userPrompt) return showMessage("Vui lòng nhập yêu cầu cho AI.");

            elements.aiButtonText.textContent = 'AI đang xử lý...';
            elements.aiButtonSpinner.classList.remove('hidden');
            elements.sendToAIButton.disabled = true;

            try {
                const selectedStyle = elements.mainStyleSelect.value;
                let instruction = `Bạn là một trợ lý lập trình. Trả lời theo định dạng: Đầu tiên, giải thích ngắn gọn. Sau đó, thêm dòng phân cách '---CODE---'. Cuối cùng, chỉ cung cấp khối mã hoàn chỉnh, sạch sẽ.`;
                if (selectedStyle) instruction += ` Áp dụng phong cách "${selectedStyle}".`;

                if (!chat) {
                    const history = [
                        { role: "user", parts: [{ text: `${instruction}\n\nMã nguồn ban đầu:\n---\n${monacoEditor.getValue()}` }] },
                        { role: "model", parts: [{ text: "Đã hiểu. Yêu cầu của bạn là gì?" }] }
                    ];
                    chat = aiModel.startChat({ history });
                }

                const result = await chat.sendMessage(userPrompt);
                const fullResponseText = result.response.text();
                const separator = '---CODE---';
                let explanation = "AI không cung cấp giải thích.";
                let code = fullResponseText;

                if (fullResponseText.includes(separator)) {
                    const parts = fullResponseText.split(separator);
                    explanation = parts[0].trim();
                    code = parts.slice(1).join(separator).trim();
                }
                
                elements.aiExplanationBox.innerHTML = explanation.replace(/\n/g, '<br>');
                monacoEditor.setValue(code);
                elements.aiPromptInput.value = '';
                showMessage("AI đã cập nhật mã và cung cấp giải thích.");

            } catch (error) {
                console.error("Error calling AI:", error);
                showMessage(`Lỗi khi gọi AI: ${error.message}`, 5000);
                chat = null;
            } finally {
                elements.aiButtonText.textContent = 'Gửi tới AI';
                elements.aiButtonSpinner.classList.add('hidden');
                elements.sendToAIButton.disabled = false;
            }
        };

        // --- Action Functions ---
        const saveVersion = async () => {
            if (!userId || !currentAppId || !monacoEditor) return showMessage('Vui lòng chọn ứng dụng và đảm bảo trình soạn thảo sẵn sàng.');

            const editorFilename = elements.fileNameInput.value.trim();
            const editorContent = monacoEditor.getValue();
            const newVersionNotes = elements.newVersionNotesInput.value.trim();
            
            // If there's content in the editor, ensure a filename is provided and update the map.
            if (editorContent && !editorFilename) {
                return showMessage("Vui lòng nhập tên tệp cho nội dung trong trình soạn thảo.", 3000);
            }
            if (editorContent) {
                // Update the currentVersionFiles map with the latest content from the editor
                // If it's a new file, it gets added. If existing, its content is updated.
                currentVersionFiles.set(editorFilename, { filename: editorFilename, content: editorContent });
            }

            if (currentVersionFiles.size === 0) {
                return showMessage("Không có tệp nào để lưu trong phiên bản này. Vui lòng thêm tệp.", 3000);
            }

            try {
                const versionsRef = getCollections.versions(currentAppId);
                const versionsSnapshot = await getDocs(query(versionsRef, where('deleted', '!=', true)));
                
                const newVersionRef = await addDoc(versionsRef, {
                    versionIndex: versionsSnapshot.size + 1,
                    notes: newVersionNotes || 'Không có ghi chú',
                    timestamp: Date.now(),
                    parentVersionId: currentVersionId, // Link to the previous version
                    deleted: false
                });

                const filesPromises = [];
                // Iterate through the `currentVersionFiles` map to save all files associated with this new version
                for (const [filename, fileData] of currentVersionFiles.entries()) {
                    filesPromises.push(addDoc(getCollections.files(currentAppId, newVersionRef.id), {
                        filename: fileData.filename,
                        content: fileData.content
                    }));
                }
                await Promise.all(filesPromises);
                
                showMessage('Phiên bản mới đã được lưu thành công!');
                
                // Immediately select the newly created version to refresh UI
                selectVersion(currentAppId, newVersionRef.id);

                // Reset editor and related inputs after successful save
                monacoEditor.setValue('// Chọn một tệp hoặc yêu cầu AI tạo mã mới...');
                elements.fileNameInput.value = '';
                elements.newVersionNotesInput.value = '';
                elements.aiPromptInput.value = '';
                elements.aiExplanationBox.innerHTML = '<p class="text-gray-500">Phần giải thích của AI sẽ xuất hiện ở đây...</p>';
                currentSelectedFilename = null; // No file selected in editor after save

            } catch (error) {
                console.error("Error saving version:", error);
                showMessage(`Lưu phiên bản thất bại: ${error.message}`, 5000);
            }
        };

        const copyCode = () => {
            if (!monacoEditor) return;
            const codeToCopy = monacoEditor.getValue();
            if (!codeToCopy) return showMessage("Không có mã để sao chép.", 3000);
            navigator.clipboard.writeText(codeToCopy).then(() => {
                showMessage('Mã đã được sao chép vào clipboard!');
            }, () => {
                showMessage('Sao chép thất bại.', 3000);
            });
        };

        const showPreview = () => {
            if (!monacoEditor) return;
            const codeToPreview = monacoEditor.getValue();
            if (!codeToPreview) return showMessage("Không có mã để xem trước.", 3000);
            elements.previewFrame.srcdoc = codeToPreview;
            elements.previewModal.classList.remove('hidden');
            setPreviewMode('desktop'); 
        };
        
        const addNewApplication = async () => {
            if (!userId) return showMessage('Vui lòng đăng nhập.');
            const appName = elements.newAppNameInput.value.trim();
            if (!appName) return showMessage('Tên ứng dụng không được để trống.');
            try {
                await addDoc(getCollections.applications(), { name: appName, createdAt: Date.now() });
                showMessage(`Ứng dụng "${appName}" đã được thêm!`);
                hideAddNewAppModal();
            }
            catch (error) { console.error("Error adding app:", error); showMessage('Thêm thất bại.', 5000); }
        };
        const showAddNewAppModal = () => { elements.newAppNameInput.value = ''; elements.addNewAppModal.classList.remove('hidden'); };
        const hideAddNewAppModal = () => elements.addNewAppModal.classList.add('hidden');
        const setPreviewMode = (mode) => {
            elements.previewFrameContainer.classList.toggle('mobile-view', mode === 'mobile');
            elements.previewModalContent.classList.toggle('desktop-mode-active', mode === 'desktop');
            elements.mobileViewBtn.classList.toggle('bg-indigo-600', mode === 'mobile');
            elements.mobileViewBtn.classList.toggle('text-white', mode === 'mobile');
            elements.desktopViewBtn.classList.toggle('bg-indigo-600', mode === 'desktop');
            elements.desktopViewBtn.classList.toggle('text-white', mode === 'desktop');
        };
        const closePreview = () => { elements.previewModal.classList.add('hidden'); elements.previewFrame.srcdoc = ''; };
        const editSelectedVersionNotes = () => {
            if (!currentVersionId) return showMessage('Chọn một phiên bản để sửa.', 3000);
            elements.versionNotesInput.disabled = false;
            elements.editVersionNotesBtn.classList.add('hidden');
            elements.saveEditedVersionNotesBtn.classList.remove('hidden');
            elements.versionNotesInput.focus();
        };
        const saveEditedVersionNotes = async () => {
            if (!userId || !currentAppId || !currentVersionId) return showMessage('Không thể lưu.', 3000);
            const newNotes = elements.versionNotesInput.value.trim();
            if (!newNotes) return showMessage('Ghi chú không được trống.', 3000);
            try {
                await updateDoc(doc(db, `users/${userId}/applications/${currentAppId}/versions/${currentVersionId}`), { notes: newNotes });
                showMessage('Ghi chú đã được cập nhật!');
                elements.versionNotesInput.disabled = true;
                elements.editVersionNotesBtn.classList.remove('hidden');
                elements.saveEditedVersionNotesBtn.classList.add('hidden');
            } catch (error) { console.error("Error saving notes:", error); showMessage(`Lỗi: ${error.message}`, 5000); }
        };
        let appToEditId = null;
        const showEditAppModal = (appId, appName) => {
            appToEditId = appId;
            elements.editAppNameInput.value = appName;
            elements.editAppModal.classList.remove('hidden');
        };
        const hideEditAppModal = () => elements.editAppModal.classList.add('hidden');
        const saveEditedApplicationName = async () => {
            if (!userId || !appToEditId) return;
            const newName = elements.editAppNameInput.value.trim();
            if (!newName) return showMessage('Tên không được trống.');
            try {
                await updateDoc(doc(db, `users/${userId}/applications/${appToEditId}`), { name: newName });
                showMessage(`Đã cập nhật tên ứng dụng!`);
                hideEditAppModal();
                if (currentAppId === appToEditId) elements.currentAppNameSpan.textContent = newName;
            } catch (error) { console.error("Error updating app name:", error); showMessage('Cập nhật thất bại.', 5000); }
        };
        const deleteApplicationCascade = async (appId) => {
            if (!confirm('CẢNH BÁO: XÓA ỨNG DỤNG NÀY VĨNH VIỄN? Hành động này không thể hoàn tác.')) return;
            try {
                const versionsSnapshot = await getDocs(getCollections.versions(appId));
                const deletePromises = [];
                for (const versionDoc of versionsSnapshot.docs) {
                    const filesSnapshot = await getDocs(getCollections.files(appId, versionDoc.id));
                    filesSnapshot.forEach((fileDoc) => deletePromises.push(deleteDoc(fileDoc.ref)));
                    deletePromises.push(deleteDoc(versionDoc.ref));
                }
                await Promise.all(deletePromises);
                await deleteDoc(doc(db, `users/${userId}/applications/${appId}`));
                showMessage('Ứng dụng đã được xóa vĩnh viễn!');
                if (currentAppId === appId) selectApplication(null, "No App Selected");
            } catch (error) { console.error("Error deleting app:", error); showMessage(`Lỗi khi xóa: ${error.message}`, 5000); }
        };
        const softDeleteVersion = async () => {
            if (!currentVersionId) return showMessage('Vui lòng chọn một phiên bản.', 3000);
            if (!confirm('Bạn có chắc muốn xóa phiên bản này?')) return;
            try {
                await updateDoc(doc(db, `users/${userId}/applications/${currentAppId}/versions/${currentVersionId}`), { deleted: true, deletedAt: serverTimestamp() });
                showMessage('Phiên bản đã được chuyển vào thùng rác!');
                currentVersionId = null;
                if(monacoEditor) monacoEditor.setValue('// Chọn một tệp hoặc yêu cầu AI tạo mã mới...');
            } catch (error) { console.error("Error soft deleting:", error); showMessage(`Lỗi: ${error.message}`, 5000); }
        };
        const showDeletedVersionsModal = () => {
            if (!currentAppId) return showMessage('Chọn một ứng dụng.', 3000);
            elements.deletedVersionsModal.classList.remove('hidden');
            loadDeletedVersions();
        };
        const closeDeletedVersionsModal = () => elements.deletedVersionsModal.classList.add('hidden');
        const loadDeletedVersions = () => {
            if (!currentAppId) return;
            const q = query(getCollections.versions(currentAppId), where('deleted', '==', true), orderBy('deletedAt', 'desc'));
            onSnapshot(q, (snapshot) => {
                elements.deletedVersionsList.innerHTML = snapshot.empty ? '<div class="text-gray-500 text-center py-4">Thùng rác trống.</div>' : '';
                const fragment = document.createDocumentFragment();
                snapshot.forEach(doc => {
                    const version = doc.data();
                    const versionItem = document.createElement('div');
                    versionItem.className = 'bg-gray-100 p-3 rounded-lg shadow-sm flex justify-between items-center gap-2 mb-2';
                    versionItem.innerHTML = `
                        <div>
                            <p class="font-medium">Phiên bản: ${version.versionIndex || 'N/A'}</p>
                            <p class="text-sm text-gray-500">${version.notes || ''}</p>
                        </div>
                        <div class="flex gap-2">
                            <button class="bg-indigo-600 text-white text-sm font-bold py-1 px-3 rounded-md restore-btn" data-version-id="${doc.id}">Khôi phục</button>
                            <button class="bg-red-600 text-white text-sm font-bold py-1 px-3 rounded-md permanent-delete-btn" data-version-id="${doc.id}">Xóa vĩnh viễn</button>
                        </div>`;
                    fragment.appendChild(versionItem);
                });
                elements.deletedVersionsList.appendChild(fragment);
            });
        };
        const restoreVersion = async (appId, versionId) => {
            if (!confirm('Khôi phục phiên bản này?')) return;
            try {
                await updateDoc(doc(db, `users/${userId}/applications/${appId}/versions/${versionId}`), { deleted: false, deletedAt: null });
                showMessage('Đã khôi phục!');
            } catch (error) { console.error("Error restoring:", error); showMessage(`Lỗi: ${error.message}`, 5000); }
        };
        const permanentDeleteVersion = async (appId, versionId) => {
            if (!confirm('CẢNH BÁO: XÓA VĨNH VIỄN?')) return;
            try {
                const filesSnapshot = await getDocs(getCollections.files(appId, versionId));
                await Promise.all(filesSnapshot.docs.map(fileDoc => deleteDoc(fileDoc.ref)));
                await deleteDoc(doc(db, `users/${userId}/applications/${appId}/versions/${versionId}`));
                showMessage('Đã xóa vĩnh viễn!');
            } catch (error) { console.error("Error permanently deleting:", error); showMessage(`Lỗi: ${error.message}`, 5000); }
        };
        
        // --- Event Listeners ---
        elements.loginBtn.addEventListener('click', () => handleAuth(false));
        elements.registerBtn.addEventListener('click', () => handleAuth(true));
        elements.logoutBtn.addEventListener('click', handleLogout);
        elements.addNewAppBtn.addEventListener('click', showAddNewAppModal);
        elements.confirmNewAppBtn.addEventListener('click', addNewApplication);
        elements.cancelNewAppBtn.addEventListener('click', hideAddNewAppModal);
        elements.saveVersionBtn.addEventListener('click', saveVersion);
        elements.sendToAIButton.addEventListener('click', callAI);
        elements.copyBtn.addEventListener('click', copyCode);
        elements.previewBtn.addEventListener('click', showPreview);
        elements.closePreviewBtn.addEventListener('click', closePreview);
        elements.softDeleteVersionBtn.addEventListener('click', softDeleteVersion);
        elements.showDeletedVersionsBtn.addEventListener('click', showDeletedVersionsModal);
        elements.closeDeletedVersionsModalBtn.addEventListener('click', closeDeletedVersionsModal);
        elements.mobileViewBtn.addEventListener('click', () => setPreviewMode('mobile'));
        elements.desktopViewBtn.addEventListener('click', () => setPreviewMode('desktop'));
        elements.editVersionNotesBtn.addEventListener('click', editSelectedVersionNotes);
        elements.saveEditedVersionNotesBtn.addEventListener('click', saveEditedVersionNotes);
        elements.confirmEditAppBtn.addEventListener('click', saveEditedApplicationName);
        elements.cancelEditAppBtn.addEventListener('click', hideEditAppModal);
        elements.toggleAiSuggestionsBtn.addEventListener('click', toggleAiSuggestions);
        elements.addNewFileBtn.addEventListener('click', () => {
            if (!currentAppId || !currentVersionId) {
                showMessage('Vui lòng chọn một ứng dụng và phiên bản trước khi thêm tệp.', 4000);
                return;
            }

            const filename = prompt('Nhập tên tệp mới (ví dụ: style.css, script.js, index.html):');
            if (!filename) return; // User cancelled

            const trimmedFilename = filename.trim();
            if (trimmedFilename === '') {
                showMessage('Tên tệp không được để trống.', 3000);
                return;
            }

            if (currentVersionFiles.has(trimmedFilename)) {
                showMessage(`Tệp "${trimmedFilename}" đã tồn tại trong phiên bản hiện tại. Vui lòng chọn tên khác.`, 4000);
                return;
            }

            // Prepare empty content and language based on extension
            let initialContent = '';
            let lang = 'plaintext';
            if (trimmedFilename.endsWith('.html')) {
                initialContent = `<!DOCTYPE html>\n<html lang="vi">\n<head>\n    <meta charset="UTF-8">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>${trimmedFilename.replace('.html', '')}</title>\n</head>\n<body>\n    <!-- Nội dung của bạn ở đây -->\n</body>\n</html>`;
                lang = 'html';
            } else if (trimmedFilename.endsWith('.css')) {
                initialContent = `/* Styles for ${trimmedFilename.replace('.css', '')} */\n`;
                lang = 'css';
            } else if (trimmedFilename.endsWith('.js')) {
                initialContent = `// JavaScript for ${trimmedFilename.replace('.js', '')}\n`;
                lang = 'javascript';
            } else if (trimmedFilename.endsWith('.json')) {
                initialContent = `{}`;
                lang = 'json';
            } else if (trimmedFilename.endsWith('.md')) {
                initialContent = `# ${trimmedFilename.replace('.md', '')}\n`;
                lang = 'markdown';
            }

            // Update UI
            elements.fileNameInput.value = trimmedFilename;
            monacoEditor.setValue(initialContent);
            monaco.editor.setModelLanguage(monacoEditor.getModel(), lang);
            
            // Set this file as currently selected for UI rendering
            currentSelectedFilename = trimmedFilename;

            // Add to currentVersionFiles map (temporarily, will be saved on next version save)
            currentVersionFiles.set(trimmedFilename, { filename: trimmedFilename, content: initialContent });

            renderVersionFilesList(); // Re-render files list to show the new file and mark it selected

            showMessage(`Đã tạo tệp mới: "${trimmedFilename}". Vui lòng sửa đổi và bấm 'Lưu phiên bản mới' để lưu các thay đổi.`, 6000);
        });

        elements.searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            renderApplications(allApps.filter(app => app.name.toLowerCase().includes(searchTerm)));
        });

        // Event Delegation
        elements.applicationsList.addEventListener('click', (e) => {
            const appItem = e.target.closest('.list-item');
            if (!appItem) return;
            const appId = appItem.dataset.appId;
            const appName = appItem.dataset.appName;
            if (e.target.classList.contains('edit-app-btn')) { showEditAppModal(appId, appName); } 
            else if (e.target.classList.contains('delete-app-btn')) { deleteApplicationCascade(appId); } 
            else { selectApplication(appId, appName); }
        });
        elements.versionsList.addEventListener('click', (e) => {
            const versionItem = e.target.closest('.list-item');
            if (versionItem && currentAppId) selectVersion(currentAppId, versionItem.dataset.versionId);
        });
        elements.versionFilesList.addEventListener('click', (e) => {
            const fileItem = e.target.closest('.list-item');
            if (fileItem) {
                const filename = fileItem.dataset.filename;
                loadFileIntoEditor(filename);
            }
        });
        elements.deletedVersionsList.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button || !currentAppId) return;
            const versionId = button.dataset.versionId;
            if (button.classList.contains('restore-btn')) restoreVersion(currentAppId, versionId);
            else if (button.classList.contains('permanent-delete-btn')) permanentDeleteVersion(currentAppId, versionId);
        });
        elements.aiPromptSuggestionsContainer.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (button) elements.aiPromptInput.value = button.dataset.prompt;
        });

    </script>
</body>
</html>
