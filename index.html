<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Version Control AI Canvas</title>
    
    <!-- Google Font: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- highlight.js CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    
    <style>
        /* CSS tùy chỉnh để giao diện đẹp hơn */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* bg-gray-100 */
            color: #374151; /* text-gray-700 */
        }
        /* Hiệu ứng khi di chuột vào nút */
        button {
            transition: all 0.3s ease;
        }
        button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        /* Kiểu cho các mục trong danh sách */
        .list-item {
            transition: all 0.2s ease;
        }
        .list-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .list-item.selected {
             background-color: #dbeafe; /* blue-100 */
             border-left: 4px solid #3b82f6; /* blue-500 */
        }
        /* Biểu tượng tải */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-left-color: #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* CSS cho Modal xem trước */
        #previewModal iframe {
            width: 100%;
            height: 80vh;
            border: 1px solid #e5e7eb; /* gray-200 */
            border-radius: 0.5rem;
        }

        /* Thêm style cho trình soạn thảo mới */
        #editorContainer {
            min-height: 200px; /* Đảm bảo chiều cao tối thiểu cho trình soạn thảo */
        }
        #editableCodeContent {
            /* Đảm bảo nội dung có thể cuộn và trông giống textarea */
            outline: none; /* Bỏ viền focus mặc định */
            tab-size: 4; /* Kích thước tab */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Phần Header -->
    <header class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4 shadow-lg flex justify-between items-center">
        <h1 class="text-3xl font-bold">Version Control AI Canvas</h1>
        <div id="authStatus" class="flex items-center space-x-4">
            <span id="userEmailDisplay" class="text-lg font-medium hidden"></span>
            <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 hidden">
                Đăng xuất
            </button>
        </div>
    </header>

    <!-- Phần Đăng nhập / Đăng ký -->
    <div id="authSection" class="flex-grow flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-3xl font-bold mb-6 text-center text-gray-800">Đăng nhập / Đăng ký</h2>
            <div class="mb-4">
                <label for="emailInput" class="block text-gray-700 text-sm font-bold mb-2">Email:</label>
                <input type="email" id="emailInput" placeholder="your@example.com" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500">
            </div>
            <div class="mb-6">
                <label for="passwordInput" class="block text-gray-700 text-sm font-bold mb-2">Mật khẩu:</label>
                <input type="password" id="passwordInput" placeholder="********" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500">
            </div>
            <div class="flex flex-col sm:flex-row gap-4">
                <button id="loginBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 flex-grow">
                    Đăng nhập
                </button>
                <button id="registerBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 flex-grow">
                    Đăng ký
                </button>
            </div>
            <p class="text-red-500 text-sm mt-4 text-center" id="authErrorMsg"></p>
        </div>
    </div>

    <!-- Nội dung chính của ứng dụng (Ẩn cho đến khi đăng nhập) -->
    <main id="mainAppContent" class="flex-grow container mx-auto p-4 grid grid-cols-1 lg:grid-cols-12 gap-6 hidden">
        
        <!-- Cột trái: Danh sách ứng dụng (15%) -->
        <section class="bg-white p-6 rounded-lg shadow-md col-span-1 lg:col-span-2 flex flex-col">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Applications</h2>
            <button id="addNewAppBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 mb-4 w-full">
                Add New Application
            </button>
            <div class="my-4">
                <input type="text" id="searchInput" placeholder="Tìm kiếm ứng dụng..." class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500">
            </div>
            <div id="applicationsList" class="space-y-3 flex-grow overflow-y-auto pr-2">
                <div class="text-gray-500 text-center py-4">Loading applications...</div>
            </div>
        </section>

        <!-- Cột giữa: Danh sách phiên bản (15%) -->
        <section class="bg-white p-6 rounded-lg shadow-md col-span-1 lg:col-span-2 flex flex-col">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Versions for <span id="currentAppName" class="font-bold text-blue-600">No App Selected</span></h2>
            <button id="showDeletedVersionsBtn" class="bg-red-400 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 mb-4 w-full">
                Xem phiên bản đã xóa
            </button>
            <div id="versionsList" class="space-y-3 flex-grow overflow-y-auto pr-2">
                <div class="text-gray-500 text-center py-4">Select an application to see versions.</div>
            </div>
        </section>

        <!-- Cột phải: AI Canvas (70%) -->
        <section class="bg-white p-6 rounded-lg shadow-md col-span-1 lg:col-span-8 flex flex-col">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">AI Canvas</h2>
            
            <!-- Tệp trong phiên bản đã chọn (Đã di chuyển lên đây) -->
            <h3 class="text-xl font-semibold mt-0 mb-3 text-gray-800">Tệp trong phiên bản đã chọn:</h3>
            <div id="versionFilesList" class="space-y-2 max-h-48 overflow-y-auto pr-2 border p-3 rounded-lg bg-gray-50 mb-4">
                <div class="text-gray-500 text-center py-2">Chọn một phiên bản để xem các tệp của nó.</div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="fileNameInput" class="block text-gray-700 text-sm font-bold mb-2">Tên tệp:</label>
                    <input type="text" id="fileNameInput" placeholder="e.g., index.html" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700">
                </div>
                <div>
                    <label for="versionNotesInput" class="block text-gray-700 text-sm font-bold mb-2">Ghi chú phiên bản:</label>
                    <input type="text" id="versionNotesInput" placeholder="e.g., 'Refactored with AI'" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700">
                </div>
            </div>

            <!-- Trình soạn thảo mã (đã thay đổi) -->
            <div class="flex-grow flex flex-col mb-4">
                <label for="editableCodeContent" class="block text-gray-700 text-sm font-bold mb-2">Trình soạn thảo:</label>
                <div id="editorContainer" class="relative flex-grow shadow-inner appearance-none border rounded-lg overflow-hidden">
                    <!-- The actual editable code block, where highlight.js will apply highlighting -->
                    <pre class="absolute inset-0 overflow-y-auto p-3 font-mono text-sm bg-white text-gray-700 leading-relaxed whitespace-pre-wrap z-10" style="tab-size: 4;"><code id="editableCodeContent" contenteditable="true" class="block min-h-full focus:outline-none" style="caret-color: #3b82f6;"></code></pre>
                    <!-- Placeholder text -->
                    <div id="editorPlaceholder" class="absolute inset-0 p-3 font-mono text-sm text-gray-400 pointer-events-none z-20">Chọn một tệp, hoặc yêu cầu AI tạo code mới...</div>
                </div>
            </div>

            <!-- KHUNG GIẢI THÍCH MỚI -->
            <div class="mb-4">
                <label for="aiExplanationBox" class="block text-gray-700 text-sm font-bold mb-2">Giải thích từ AI:</label>
                <div id="aiExplanationBox" class="w-full h-32 p-3 bg-gray-100 border rounded-lg overflow-y-auto text-sm">
                    <p class="text-gray-500">Phần giải thích của AI sẽ xuất hiện ở đây...</p>
                </div>
            </div>
            
            <div class="bg-gray-50 p-4 rounded-lg border">
                 <label for="aiPromptInput" class="block text-gray-700 text-sm font-bold mb-2">Yêu cầu cho AI:</label>
                 <textarea id="aiPromptInput" rows="3" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700" placeholder="e.g., 'Thêm bình luận cho hàm này' hoặc 'Tạo một nút bấm màu đỏ'"></textarea>
                 
                 <!-- NEW: AI Prompt Suggestions -->
                 <div class="mt-3">
                     <label class="block text-gray-700 text-sm font-bold mb-2">Gợi ý câu lệnh AI:</label>
                     <div id="aiPromptSuggestions" class="flex flex-wrap gap-2">
                         <!-- Suggestions will be injected here by JS -->
                     </div>
                 </div>

                 <button id="sendToAIButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 mt-3 w-full flex items-center justify-center gap-2">
                    <span id="aiButtonText">Gửi tới AI</span>
                    <div id="aiButtonSpinner" class="spinner hidden"></div>
                </button>
            </div>

            <!-- NÚT HÀNH ĐỘNG -->
            <div class="mt-6 grid grid-cols-1 sm:grid-cols-4 gap-4">
                 <button id="saveVersionBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 w-full">
                    Lưu phiên bản mới
                </button>
                <button id="copyBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 w-full">
                    Sao chép mã
                </button>
                <button id="previewBtn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 w-full">
                    Xem trước mã
                </button>
                <!-- NÚT XÓA (Soft Delete) -->
                <button id="softDeleteVersionBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 w-full">
                    Xóa phiên bản
                </button>
            </div>
        </section>
    </main>

    <!-- Hộp thông báo tùy chỉnh -->
    <div id="messageBox" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg hidden z-50 transition-opacity duration-300 opacity-0">
        <span id="messageContent"></span>
    </div>

    <!-- Modal để thêm ứng dụng mới -->
    <div id="addNewAppModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-2xl font-bold mb-6 text-gray-800">Add New Application</h3>
            <div class="mb-4">
                <label for="newAppNameInput" class="block text-gray-700 text-sm font-bold mb-2">Application Name:</label>
                <input type="text" id="newAppNameInput" placeholder="e.g., 'My Blog App'" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500">
            </div>
            <div class="flex justify-end gap-4">
                <button id="cancelNewAppBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">Cancel</button>
                <button id="confirmNewAppBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Add Application</button>
            </div>
        </div>
    </div>

    <!-- MODAL XEM TRƯỚC -->
    <div id="previewModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-4xl flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-xl font-semibold">Bản xem trước</h3>
                <button id="closePreviewBtn" class="text-gray-500 hover:text-gray-800 text-3xl font-bold">&times;</button>
            </div>
            <div class="p-4">
                <iframe id="previewFrame" title="Preview Content"></iframe>
            </div>
        </div>
    </div>

    <!-- MODAL PHIÊN BẢN ĐÃ XÓA MỚI -->
    <div id="deletedVersionsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <h3 class="text-2xl font-bold mb-6 text-gray-800">Phiên bản đã xóa</h3>
            <div id="deletedVersionsList" class="space-y-3 flex-grow overflow-y-auto pr-2">
                <div class="text-gray-500 text-center py-4">Đang tải các phiên bản đã xóa...</div>
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button id="closeDeletedVersionsModalBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">Đóng</button>
            </div>
        </div>
    </div>


    <!-- highlight.js JS - Đã di chuyển lên đây để đảm bảo tải trước script module -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <!-- Firebase SDK và script tùy chỉnh -->
    <script type="module">
        // Import các module cần thiết từ Firebase (sử dụng phiên bản 12.0.0 như code gốc)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, getDocs, getDoc, onSnapshot, query, orderBy, setDoc, updateDoc, deleteDoc, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
        
        // **QUAY LẠI SỬ DỤNG FIREBASE AI SDK NHƯ CODE GỐC**
        import { getAI, getGenerativeModel, GoogleAIBackend } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-ai.js";

        // --- Cấu hình Firebase ---
        // LƯU Ý QUAN TRỌNG: Thay thế các giá trị dưới đây bằng cấu hình Firebase của chính bạn.
        const firebaseConfig = {
            apiKey: "AIzaSyD7I9ZKYFTc71tFMGA2lM72ykwDuwhEV0o",
            authDomain: "tudien-b2d17.firebaseapp.com",
            projectId: "tudien-b2d17",
            storageBucket: "tudien-b2d17.firebasestorage.app",
            messagingSenderId: "496472238606",
            appId: "1:496472238606:web:79769d3c38e546a27dea5f"
        };

        // --- Khởi tạo Firebase ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- Khởi tạo AI Model thông qua Firebase AI SDK ---
        let aiModel;
        try {
            const ai = getAI(app, { backend: new GoogleAIBackend() });
            aiModel = getGenerativeModel(ai, { model: "gemini-2.5-flash" });
            console.log("Generative Model initialized successfully via Firebase AI SDK.");
        } catch (e) {
            console.error("Error initializing AI Model:", e);
            showMessage("Lỗi khởi tạo AI Model. Kiểm tra Console.", 5000);
        }

        // --- Biến toàn cục và tham chiếu DOM ---
        let currentAppId = null;
        let currentAppName = null;
        let currentVersionId = null; 
        let userId = null;
        let allApps = []; // Cache all apps for filtering
        let chat = null; // **BIẾN MỚI: Lưu trữ phiên trò chuyện với AI**
        let currentVersionFiles = new Map(); // Store files for the currently selected version to avoid re-fetching

        // DOM References
        const elements = {
            // Auth
            authSection: document.getElementById('authSection'),
            mainAppContent: document.getElementById('mainAppContent'),
            emailInput: document.getElementById('emailInput'),
            passwordInput: document.getElementById('passwordInput'),
            loginBtn: document.getElementById('loginBtn'),
            registerBtn: document.getElementById('registerBtn'),
            logoutBtn: document.getElementById('logoutBtn'),
            userEmailDisplay: document.getElementById('userEmailDisplay'),
            authErrorMsg: document.getElementById('authErrorMsg'),
            // App & Version Lists
            applicationsList: document.getElementById('applicationsList'),
            versionsList: document.getElementById('versionsList'),
            currentAppNameSpan: document.getElementById('currentAppName'),
            searchInput: document.getElementById('searchInput'),
            // AI Canvas & Editor
            versionFilesList: document.getElementById('versionFilesList'),
            fileNameInput: document.getElementById('fileNameInput'),
            versionNotesInput: document.getElementById('versionNotesInput'),
            editorContainer: document.getElementById('editorContainer'),
            editableCodeContent: document.getElementById('editableCodeContent'),
            editorPlaceholder: document.getElementById('editorPlaceholder'),
            aiPromptInput: document.getElementById('aiPromptInput'),
            sendToAIButton: document.getElementById('sendToAIButton'),
            aiButtonText: document.getElementById('aiButtonText'),
            aiButtonSpinner: document.getElementById('aiButtonSpinner'),
            aiExplanationBox: document.getElementById('aiExplanationBox'),
            aiPromptSuggestionsContainer: document.getElementById('aiPromptSuggestions'),
            // Actions
            saveVersionBtn: document.getElementById('saveVersionBtn'),
            copyBtn: document.getElementById('copyBtn'),
            previewBtn: document.getElementById('previewBtn'),
            softDeleteVersionBtn: document.getElementById('softDeleteVersionBtn'),
            // Modals & Messages
            messageBox: document.getElementById('messageBox'),
            messageContent: document.getElementById('messageContent'),
            addNewAppBtn: document.getElementById('addNewAppBtn'),
            addNewAppModal: document.getElementById('addNewAppModal'),
            newAppNameInput: document.getElementById('newAppNameInput'),
            confirmNewAppBtn: document.getElementById('confirmNewAppBtn'),
            cancelNewAppBtn: document.getElementById('cancelNewAppBtn'),
            previewModal: document.getElementById('previewModal'),
            closePreviewBtn: document.getElementById('closePreviewBtn'),
            previewFrame: document.getElementById('previewFrame'),
            showDeletedVersionsBtn: document.getElementById('showDeletedVersionsBtn'),
            deletedVersionsModal: document.getElementById('deletedVersionsModal'),
            deletedVersionsList: document.getElementById('deletedVersionsList'),
            closeDeletedVersionsModalBtn: document.getElementById('closeDeletedVersionsModalBtn'),
        };

        const mainCodeEditor = elements.editableCodeContent; // Map lại biến cũ `mainCodeEditor` vào element mới

        const aiPromptSuggestions = [
            "Tạo cho tôi một ứng dụng web viết bằng html tích hợp js và css. Giao diện TailwindCss hiện đại. Nội dung của nó là:", // CÂU LỆNH MỚI
            "Thêm CSS để căn giữa nội dung trang và đặt màu nền là màu xanh nhạt (#e0f7fa).",
            "Viết JavaScript để khi click nút 'Click me' sẽ hiển thị thông báo 'Bạn đã click!'",
            "Giải thích đoạn mã HTML/CSS/JS này hoạt động như thế nào.",
            "Tối ưu hóa mã nguồn này để nó chạy nhanh hơn và dễ đọc hơn."
        ];

        // --- highlight.js script ---
        function applyHighlighting() {
            if (typeof hljs === 'undefined') return;

            // Xóa tất cả các lớp ngôn ngữ cũ để tránh xung đột
            mainCodeEditor.className = mainCodeEditor.className.split(' ')
                                     .filter(cls => !cls.startsWith('language-'))
                                     .join(' ');

            const filename = elements.fileNameInput.value.trim();
            let langClass = '';

            // Gán lớp ngôn ngữ dựa trên phần mở rộng của tên tệp
            if (filename.endsWith('.html') || filename.endsWith('.htm')) {
                langClass = 'language-xml'; // highlight.js sử dụng 'xml' cho HTML
            } else if (filename.endsWith('.css')) {
                langClass = 'language-css';
            } else if (filename.endsWith('.js') || filename.endsWith('.json')) {
                langClass = 'language-javascript'; // hoặc 'json'
            } else {
                // Mặc định là HTML (xml) hoặc văn bản thuần nếu không có phần mở rộng cụ thể
                // Thường thì AI sẽ trả về hỗn hợp HTML/JS/CSS, nên 'xml' là một lựa chọn chung tốt.
                langClass = 'language-xml'; 
            }
            
            if (langClass) {
                mainCodeEditor.classList.add(langClass);
            }

            hljs.highlightElement(mainCodeEditor); 
        }

        // --- Hàm tiện ích ---
        function showMessage(message, duration = 3000) {
            elements.messageContent.textContent = message;
            elements.messageBox.classList.remove('hidden', 'opacity-0');
            elements.messageBox.classList.add('opacity-100');
            setTimeout(() => {
                elements.messageBox.classList.remove('opacity-100');
                elements.messageBox.classList.add('opacity-0');
                setTimeout(() => elements.messageBox.classList.add('hidden'), 300);
            }, duration);
        }

        function showAuthError(message) {
            elements.authErrorMsg.textContent = message;
        }

        // --- Logic Placeholder cho trình soạn thảo ---
        function toggleEditorPlaceholder() {
            if (mainCodeEditor.textContent.trim() === '') {
                elements.editorPlaceholder.style.display = 'block';
            } else {
                elements.editorPlaceholder.style.display = 'none';
            }
        }

        // NEW: Hàm render gợi ý câu lệnh AI
        function renderAiPromptSuggestions() {
            elements.aiPromptSuggestionsContainer.innerHTML = '';
            const fragment = document.createDocumentFragment();
            aiPromptSuggestions.forEach(prompt => {
                const button = document.createElement('button');
                button.textContent = prompt;
                button.className = 'bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm py-1 px-3 rounded-md transition duration-200 whitespace-nowrap overflow-hidden text-ellipsis';
                button.title = prompt;
                button.dataset.prompt = prompt; // Use dataset for click handler
                fragment.appendChild(button);
            });
            elements.aiPromptSuggestionsContainer.appendChild(fragment);
        }

        // --- Xác thực Firebase ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                elements.userEmailDisplay.textContent = user.email || "Anonymous";
                elements.userEmailDisplay.classList.remove('hidden');
                elements.logoutBtn.classList.remove('hidden');
                elements.authSection.classList.add('hidden');
                elements.mainAppContent.classList.remove('hidden');
                elements.mainAppContent.classList.add('grid');
                loadApplications();
                toggleEditorPlaceholder();
                renderAiPromptSuggestions();
            } else {
                userId = null;
                elements.userEmailDisplay.classList.add('hidden');
                elements.logoutBtn.classList.add('hidden');
                elements.authSection.classList.remove('hidden');
                elements.mainAppContent.classList.add('hidden');
                elements.mainAppContent.classList.remove('grid');
            }
        });

        // --- Các hàm xác thực ---
        const handleAuth = async (isRegister) => {
            const email = elements.emailInput.value.trim();
            const password = elements.passwordInput.value.trim();
            if (!email || !password) {
                return showAuthError("Vui lòng nhập email và mật khẩu.");
            }
            try {
                if (isRegister) {
                    await createUserWithEmailAndPassword(auth, email, password);
                    showMessage("Đăng ký thành công!");
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                    showMessage("Đăng nhập thành công!");
                }
                showAuthError(''); // Clear error message on success
            } catch (error) {
                showAuthError(error.message);
            }
        };

        const handleLogout = () => signOut(auth).then(() => showMessage("Đã đăng xuất."));

        // --- Logic Firestore ---
        const getCollections = {
            applications: () => collection(db, `users/${userId}/applications`),
            versions: (appId) => collection(db, `users/${userId}/applications/${appId}/versions`),
            files: (appId, versionId) => collection(db, `users/${userId}/applications/${appId}/versions/${versionId}/files`)
        };

        const getFilesForVersion = async (appId, versionId) => {
            const files = new Map();
            let currentId = versionId;
            while (currentId) {
                const versionRef = doc(db, `users/${userId}/applications/${appId}/versions/${currentId}`);
                const versionSnap = await getDoc(versionRef);
                if (!versionSnap.exists()) break;
                const versionData = versionSnap.data();
                
                const filesQuery = query(getCollections.files(appId, currentId));
                const filesSnapshot = await getDocs(filesQuery);
                filesSnapshot.forEach(fileDoc => {
                    const fileData = fileDoc.data();
                    if (!files.has(fileData.filename)) {
                        files.set(fileData.filename, { ...fileData, id: fileDoc.id, versionId: currentId });
                    }
                });

                currentId = versionData.parentVersionId || null;
            }
            return files;
        };

        // --- Các hàm render giao diện ---
        const renderApplications = (appsToRender) => {
            elements.applicationsList.innerHTML = '';
            if (appsToRender.length === 0) {
                elements.applicationsList.innerHTML = '<div class="text-gray-500 text-center py-4">Chưa có ứng dụng nào.</div>';
                return;
            }
            const fragment = document.createDocumentFragment();
            appsToRender.forEach((appData, index) => {
                const appItem = document.createElement('div');
                appItem.className = 'list-item bg-gray-100 hover:bg-blue-100 p-3 rounded-lg cursor-pointer transition duration-200 shadow-sm flex justify-between items-center';
                if (appData.id === currentAppId) appItem.classList.add('selected');
                appItem.innerHTML = `<span class="font-medium text-gray-700">${index + 1}. ${appData.name}</span>`;
                appItem.dataset.appId = appData.id;
                appItem.dataset.appName = appData.name;
                fragment.appendChild(appItem);
            });
            elements.applicationsList.appendChild(fragment);
        };

        const loadApplications = () => {
            if (!userId) return;
            const q = query(getCollections.applications(), orderBy('createdAt', 'desc'));
            onSnapshot(q, (snapshot) => {
                allApps = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderApplications(allApps);
            }, (error) => console.error("Error loading applications:", error));
        };

        const selectApplication = (appId, appName) => {
            currentAppId = appId;
            currentAppName = appName;
            currentVersionId = null;
            chat = null;
            currentVersionFiles.clear(); // Clear cached files

            elements.currentAppNameSpan.textContent = appName;
            document.querySelectorAll('#applicationsList > div').forEach(el => el.classList.remove('selected'));
            document.querySelector(`#applicationsList [data-app-id="${appId}"]`)?.classList.add('selected');

            loadVersions(appId);
            mainCodeEditor.textContent = '';
            applyHighlighting();
            toggleEditorPlaceholder();
            elements.fileNameInput.value = '';
            elements.versionNotesInput.value = '';
            elements.versionFilesList.innerHTML = '<div class="text-gray-500 text-center py-2">Chọn một phiên bản để xem tệp.</div>';
            elements.aiExplanationBox.innerHTML = '<p class="text-gray-500">Phần giải thích của AI sẽ xuất hiện ở đây...</p>';
            elements.aiPromptInput.value = '';
        };

        const loadVersions = (appId) => {
            if (!userId || !appId) return;
            const q = query(getCollections.versions(appId), where('deleted', '!=', true), orderBy('timestamp', 'desc'));
            onSnapshot(q, (snapshot) => {
                elements.versionsList.innerHTML = '';
                if (snapshot.empty) {
                    elements.versionsList.innerHTML = '<div class="text-gray-500 text-center py-4">Chưa có phiên bản nào.</div>';
                    return;
                }
                const fragment = document.createDocumentFragment();
                snapshot.forEach(doc => {
                    const version = doc.data();
                    const versionItem = document.createElement('div');
                    versionItem.className = 'list-item bg-gray-100 hover:bg-blue-100 p-3 rounded-lg cursor-pointer transition duration-200 shadow-sm';
                    if (doc.id === currentVersionId) versionItem.classList.add('selected');
                    const date = new Date(version.timestamp).toLocaleString();
                    versionItem.innerHTML = `
                        <p class="font-medium text-gray-700">Phiên bản: ${version.versionIndex || 'N/A'}</p>
                        <p class="text-sm text-gray-500">${version.notes || 'Không có ghi chú'}</p>
                        <p class="text-xs text-gray-400">${date}</p>`;
                    versionItem.dataset.versionId = doc.id;
                    fragment.appendChild(versionItem);
                });
                elements.versionsList.appendChild(fragment);
            });
        };

        const selectVersion = async (appId, versionId) => {
            currentVersionId = versionId;
            chat = null; // Reset chat session
            elements.aiPromptInput.value = ''; // Reset AI prompt input

            document.querySelectorAll('#versionsList > div').forEach(el => el.classList.remove('selected'));
            document.querySelector(`#versionsList [data-version-id="${versionId}"]`)?.classList.add('selected');

            elements.versionFilesList.innerHTML = '<div class="text-gray-500 text-center py-2">Đang tải tệp...</div>';
            elements.aiExplanationBox.innerHTML = '<p class="text-gray-500">Phần giải thích của AI sẽ xuất hiện ở đây...</p>';

            try {
                currentVersionFiles = await getFilesForVersion(appId, versionId);
                elements.versionFilesList.innerHTML = '';
                if (currentVersionFiles.size > 0) {
                    const sortedFiles = Array.from(currentVersionFiles.values()).sort((a, b) => a.filename.localeCompare(b.filename));
                    const fragment = document.createDocumentFragment();
                    sortedFiles.forEach(fileData => {
                        const fileItem = document.createElement('div');
                        fileItem.className = 'list-item bg-gray-100 hover:bg-blue-100 p-2 rounded-lg cursor-pointer transition duration-200 shadow-sm text-sm';
                        fileItem.textContent = fileData.filename;
                        fileItem.dataset.filename = fileData.filename; // Store filename for click delegation
                        fragment.appendChild(fileItem);
                    });
                    elements.versionFilesList.appendChild(fragment);
                } else {
                    elements.versionFilesList.innerHTML = '<div class="text-gray-500 text-center py-2">Không tìm thấy tệp nào.</div>';
                }
            } catch (error) {
                console.error("Error loading files for version:", error);
                elements.versionFilesList.innerHTML = '<div class="text-red-500 text-center py-2">Lỗi khi tải tệp.</div>';
            }
        };

        const loadFileIntoEditor = (filename) => {
            const fileData = currentVersionFiles.get(filename);
            if (fileData) {
                elements.fileNameInput.value = fileData.filename;
                mainCodeEditor.textContent = fileData.content;
                applyHighlighting();
                toggleEditorPlaceholder();
                showMessage(`Đã tải ${fileData.filename} vào trình soạn thảo.`);
                chat = null;
                elements.aiExplanationBox.innerHTML = '<p class="text-gray-500">Phần giải thích của AI sẽ xuất hiện ở đây...</p>';
            }
        };

        // --- Logic AI Canvas (Sử dụng Firebase AI SDK với ngữ cảnh hội thoại) ---
        const callAI = async () => {
            if (!aiModel) {
                return showMessage("Mô hình AI chưa sẵn sàng.", 3000);
            }
            const userPrompt = elements.aiPromptInput.value.trim();
            if (!userPrompt) return showMessage("Vui lòng nhập yêu cầu cho AI.");

            elements.aiButtonText.textContent = 'Đang xử lý...';
            elements.aiButtonSpinner.classList.remove('hidden');
            elements.sendToAIButton.disabled = true;

            try {
                const instruction = `Bạn là một trợ lý lập trình chuyên nghiệp. Hãy trả lời theo định dạng sau: Đầu tiên, đưa ra lời giải thích ngắn gọn. Sau đó, thêm một dòng chỉ chứa dấu phân cách '---CODE---'. Cuối cùng, chỉ cung cấp khối mã hoàn chỉnh, sạch sẽ mà không có bất kỳ định dạng markdown nào khác.`;

                if (!chat) {
                    const currentCode = mainCodeEditor.textContent;
                    const history = [
                        {
                            role: "user",
                            parts: [{ text: `${instruction}\n\nMã nguồn ban đầu để làm việc là:\n---\n${currentCode}` }],
                        },
                        {
                            role: "model",
                            parts: [{ text: "Đã hiểu. Tôi đã nhận được mã nguồn và sẽ tuân theo định dạng được yêu cầu. Yêu cầu của bạn là gì?" }],
                        }
                    ];
                    chat = aiModel.startChat({ history });
                }

                const result = await chat.sendMessage(userPrompt);
                const fullResponseText = result.response.text();

                const separator = '---CODE---';
                let explanation = "AI không cung cấp giải thích cho lần này.";
                let code = fullResponseText;

                if (fullResponseText.includes(separator)) {
                    const parts = fullResponseText.split(separator);
                    explanation = parts[0].trim();
                    code = parts.slice(1).join(separator).trim();
                }
                
                elements.aiExplanationBox.innerHTML = explanation.replace(/\n/g, '<br>');
                mainCodeEditor.textContent = code;
                applyHighlighting();
                toggleEditorPlaceholder();
                elements.aiPromptInput.value = '';
                showMessage("AI đã cập nhật mã và cung cấp giải thích.");

            } catch (error) {
                console.error("Error calling AI via Firebase:", error);
                showMessage(`Lỗi khi gọi AI: ${error.message}`, 5000);
                chat = null;
            } finally {
                elements.aiButtonText.textContent = 'Gửi tới AI';
                elements.aiButtonSpinner.classList.add('hidden');
                elements.sendToAIButton.disabled = false;
            }
        };

        // --- Các hàm hành động ---
        const saveVersion = async () => {
            if (!userId || !currentAppId) return showMessage('Vui lòng chọn một ứng dụng.');
            const filename = elements.fileNameInput.value.trim();
            const content = mainCodeEditor.textContent;
            if (!filename || !content) return showMessage(`Tên tệp và nội dung không được để trống.`);

            try {
                const versionsQuery = query(getCollections.versions(currentAppId), where('deleted', '!=', true));
                const versionsSnapshot = await getDocs(versionsQuery);
                const newVersionIndex = versionsSnapshot.size + 1;

                const newVersionRef = await addDoc(getCollections.versions(currentAppId), {
                    versionIndex: newVersionIndex,
                    notes: elements.versionNotesInput.value.trim() || 'Không có ghi chú',
                    timestamp: Date.now(),
                    parentVersionId: currentVersionId,
                    deleted: false
                });

                await addDoc(getCollections.files(currentAppId, newVersionRef.id), {
                    filename,
                    content
                });
                
                showMessage('Phiên bản mới đã được lưu thành công!');
                mainCodeEditor.textContent = '';
                applyHighlighting();
                toggleEditorPlaceholder();
                elements.fileNameInput.value = '';
                elements.versionNotesInput.value = '';
                elements.aiPromptInput.value = '';
                elements.aiExplanationBox.innerHTML = '<p class="text-gray-500">Phần giải thích của AI sẽ xuất hiện ở đây...</p>';
            } catch (error) {
                console.error("Error saving version:", error);
                showMessage('Lưu phiên bản thất bại.', 5000);
            }
        };

        const addNewApplication = async () => {
            if (!userId) return;
            const appName = elements.newAppNameInput.value.trim();
            if (!appName) return showMessage('Tên ứng dụng không được để trống.');
            try {
                await addDoc(getCollections.applications(), { 
                    name: appName, 
                    createdAt: Date.now()
                });
                showMessage(`Ứng dụng "${appName}" đã được thêm!`);
                hideAddNewAppModal();
            }
            catch (error) {
                console.error("Error adding new application:", error);
                showMessage('Thêm ứng dụng mới thất bại.', 5000);
            }
        };
        
        const showAddNewAppModal = () => {
            if (!userId) return showMessage('Vui lòng đăng nhập để thêm ứng dụng.');
            elements.newAppNameInput.value = '';
            elements.addNewAppModal.classList.remove('hidden');
        };

        const hideAddNewAppModal = () => elements.addNewAppModal.classList.add('hidden');

        // --- LOGIC CHO CÁC TÍNH NĂNG MỚI ---
        const showPreview = () => {
            const codeToPreview = mainCodeEditor.textContent;
            if (!codeToPreview) {
                return showMessage("Không có mã trong trình soạn thảo để xem trước.", 3000);
            }
            elements.previewFrame.srcdoc = codeToPreview;
            elements.previewModal.classList.remove('hidden');
        };

        const closePreview = () => {
            elements.previewModal.classList.add('hidden');
            elements.previewFrame.srcdoc = '';
        };

        const copyCode = () => {
            const codeToCopy = mainCodeEditor.textContent;
            if (!codeToCopy) {
                return showMessage("Không có mã trong trình soạn thảo để sao chép.", 3000);
            }
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = codeToCopy;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            document.execCommand('copy');
            document.body.removeChild(tempTextArea);
            showMessage('Mã đã được sao chép vào clipboard!');
        };

        // --- LOGIC CHO THÙNG RÁC ---

        const softDeleteVersion = async () => {
            if (!userId) return showMessage('Vui lòng đăng nhập.', 3000);
            if (!currentAppId) return showMessage('Vui lòng chọn một ứng dụng.', 3000);
            if (!currentVersionId) return showMessage('Vui lòng chọn một phiên bản để xóa.', 3000);

            if (!confirm('Bạn có chắc chắn muốn chuyển phiên bản này vào thùng rác? Bạn có thể khôi phục nó sau này từ mục "Phiên bản đã xóa".')) {
                return;
            }

            try {
                const versionRef = doc(db, `users/${userId}/applications/${currentAppId}/versions/${currentVersionId}`);
                await updateDoc(versionRef, {
                    deleted: true,
                    deletedAt: serverTimestamp()
                });
                
                showMessage('Phiên bản đã được chuyển vào thùng rác!');
                currentVersionId = null;
                mainCodeEditor.textContent = '';
                applyHighlighting();
                toggleEditorPlaceholder();
                elements.fileNameInput.value = '';
                elements.versionNotesInput.value = '';
                elements.aiPromptInput.value = '';
                elements.aiExplanationBox.innerHTML = '<p class="text-gray-500">Phần giải thích của AI sẽ xuất hiện ở đây...</p>';
                elements.versionFilesList.innerHTML = '<div class="text-gray-500 text-center py-2">Chọn một phiên bản để xem các tệp của nó.</div>';
                chat = null;

                loadVersions(currentAppId);
            } catch (error) {
                console.error("Error soft deleting version:", error);
                showMessage(`Lỗi khi chuyển phiên bản vào thùng rác: ${error.message}`, 5000);
            }
        };

        const showDeletedVersionsModal = () => {
            if (!userId || !currentAppId) {
                return showMessage('Vui lòng chọn một ứng dụng để xem các phiên bản đã xóa.', 3000);
            }
            elements.deletedVersionsModal.classList.remove('hidden');
            loadDeletedVersions();
        };

        const closeDeletedVersionsModal = () => {
            elements.deletedVersionsModal.classList.add('hidden');
            elements.deletedVersionsList.innerHTML = '<div class="text-gray-500 text-center py-4">Đang tải các phiên bản đã xóa...</div>';
        };

        const loadDeletedVersions = () => {
            if (!userId || !currentAppId) return;
            const q = query(getCollections.versions(currentAppId), where('deleted', '==', true), orderBy('deletedAt', 'desc'));
            onSnapshot(q, (snapshot) => {
                elements.deletedVersionsList.innerHTML = '';
                if (snapshot.empty) {
                    elements.deletedVersionsList.innerHTML = '<div class="text-gray-500 text-center py-4">Thùng rác trống.</div>';
                    return;
                }
                const fragment = document.createDocumentFragment();
                snapshot.forEach(doc => {
                    const version = doc.data();
                    const versionItem = document.createElement('div');
                    versionItem.className = 'bg-gray-100 p-3 rounded-lg shadow-sm flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 mb-2';
                    const deletedAtDate = version.deletedAt ? new Date(version.deletedAt.toDate()).toLocaleString() : 'N/A';
                    
                    versionItem.innerHTML = `
                        <div>
                            <p class="font-medium text-gray-700">Phiên bản: ${version.versionIndex || 'N/A'}</p>
                            <p class="text-sm text-gray-500">${version.notes || 'Không có ghi chú'}</p>
                            <p class="text-xs text-gray-400">Đã xóa vào: ${deletedAtDate}</p>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-2 mt-2 sm:mt-0">
                            <button class="bg-blue-500 hover:bg-blue-600 text-white text-sm font-bold py-1 px-3 rounded-md transition duration-300 restore-btn" data-version-id="${doc.id}">Khôi phục</button>
                            <button class="bg-red-600 hover:bg-red-700 text-white text-sm font-bold py-1 px-3 rounded-md transition duration-300 permanent-delete-btn" data-version-id="${doc.id}">Xóa vĩnh viễn</button>
                        </div>
                    `;
                    fragment.appendChild(versionItem);
                });
                elements.deletedVersionsList.appendChild(fragment);
            });
        };

        const restoreVersion = async (appId, versionId) => {
            if (!userId || !appId || !versionId) return;

            if (!confirm('Bạn có chắc chắn muốn khôi phục phiên bản này?')) {
                return;
            }

            try {
                const versionRef = doc(db, `users/${userId}/applications/${appId}/versions/${versionId}`);
                await updateDoc(versionRef, {
                    deleted: false,
                    deletedAt: null
                });
                showMessage('Phiên bản đã được khôi phục thành công!');
            } catch (error) {
                console.error("Error restoring version:", error);
                showMessage(`Lỗi khi khôi phục phiên bản: ${error.message}`, 5000);
            }
        };

        const permanentDeleteVersion = async (appId, versionId) => {
            if (!userId || !appId || !versionId) return;

            if (!confirm('CẢNH BÁO: Bạn có chắc chắn muốn XÓA VĨNH VIỄN phiên bản này? Hành động này không thể hoàn tác và sẽ xóa tất cả các tệp liên quan đến phiên bản này.')) {
                return;
            }

            try {
                const filesSnapshot = await getDocs(getCollections.files(appId, versionId));
                const deleteFilePromises = [];
                filesSnapshot.forEach((fileDoc) => {
                    deleteFilePromises.push(deleteDoc(fileDoc.ref));
                });
                await Promise.all(deleteFilePromises);

                await deleteDoc(doc(db, `users/${userId}/applications/${appId}/versions/${versionId}`));
                
                showMessage('Phiên bản và các tệp của nó đã được xóa vĩnh viễn!');
            } catch (error) {
                console.error("Error permanently deleting version:", error);
                showMessage(`Lỗi khi xóa vĩnh viễn phiên bản: ${error.message}`, 5000);
            }
        };


        // --- Gắn các sự kiện (sử dụng Event Delegation khi có thể) ---
        elements.loginBtn.addEventListener('click', () => handleAuth(false));
        elements.registerBtn.addEventListener('click', () => handleAuth(true));
        elements.logoutBtn.addEventListener('click', handleLogout);

        elements.addNewAppBtn.addEventListener('click', showAddNewAppModal);
        elements.confirmNewAppBtn.addEventListener('click', addNewApplication);
        elements.cancelNewAppBtn.addEventListener('click', hideAddNewAppModal);
        elements.saveVersionBtn.addEventListener('click', saveVersion);
        elements.sendToAIButton.addEventListener('click', callAI);
        elements.copyBtn.addEventListener('click', copyCode);
        elements.previewBtn.addEventListener('click', showPreview);
        elements.closePreviewBtn.addEventListener('click', closePreview);
        elements.softDeleteVersionBtn.addEventListener('click', softDeleteVersion);
        elements.showDeletedVersionsBtn.addEventListener('click', showDeletedVersionsModal);
        elements.closeDeletedVersionsModalBtn.addEventListener('click', closeDeletedVersionsModal);

        elements.searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredApps = allApps.filter(app => app.name.toLowerCase().includes(searchTerm));
            renderApplications(filteredApps);
        });

        // Event delegation for applications list
        elements.applicationsList.addEventListener('click', (e) => {
            const appItem = e.target.closest('.list-item');
            if (appItem && appItem.dataset.appId) {
                selectApplication(appItem.dataset.appId, appItem.dataset.appName);
            }
        });

        // Event delegation for versions list
        elements.versionsList.addEventListener('click', (e) => {
            const versionItem = e.target.closest('.list-item');
            if (versionItem && versionItem.dataset.versionId && currentAppId) {
                selectVersion(currentAppId, versionItem.dataset.versionId);
            }
        });

        // Event delegation for version files list
        elements.versionFilesList.addEventListener('click', (e) => {
            const fileItem = e.target.closest('.list-item');
            if (fileItem && fileItem.dataset.filename) {
                loadFileIntoEditor(fileItem.dataset.filename);
            }
        });

        // Event delegation for deleted versions modal buttons
        elements.deletedVersionsList.addEventListener('click', (e) => {
            if (e.target.classList.contains('restore-btn') && currentAppId) {
                restoreVersion(currentAppId, e.target.dataset.versionId);
            } else if (e.target.classList.contains('permanent-delete-btn') && currentAppId) {
                permanentDeleteVersion(currentAppId, e.target.dataset.versionId);
            }
        });

        // Event delegation for AI prompt suggestions
        elements.aiPromptSuggestionsContainer.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (button && button.dataset.prompt) {
                elements.aiPromptInput.value = button.dataset.prompt;
                elements.aiPromptInput.focus();
            }
        });

        // Gắn sự kiện cho trình soạn thảo mới
        mainCodeEditor.addEventListener('input', () => {
            applyHighlighting();
            toggleEditorPlaceholder();
        });
        mainCodeEditor.addEventListener('focus', () => {
            elements.editorPlaceholder.style.display = 'none';
        });
        mainCodeEditor.addEventListener('blur', () => {
            toggleEditorPlaceholder();
        });

        // Xử lý phím Tab trong contenteditable
        mainCodeEditor.addEventListener('keydown', (e) => {
            if (e.key === 'Tab') {
                e.preventDefault();
                const selection = window.getSelection();
                const range = selection.getRangeAt(0);
                
                const tabNode = document.createTextNode('\t');
                range.insertNode(tabNode);
                
                range.setStartAfter(tabNode);
                range.setEndAfter(tabNode);
                selection.removeAllRanges();
                selection.addRange(range);

                applyHighlighting();
                toggleEditorPlaceholder();
            }
        });

        // Initial calls
        toggleEditorPlaceholder();
        renderAiPromptSuggestions();
    </script>
</body>
</html>
