<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Version Control AI Canvas</title>
    
    <!-- Google Font: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- highlight.js CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    
    <style>
        /* CSS tùy chỉnh để giao diện đẹp hơn và theo Material Design */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Màu nền nhẹ hơn, gần với Material background */
            color: #424242; /* Màu văn bản đậm hơn để dễ đọc */
        }
        /* Hiệu ứng khi di chuột vào nút - Material Elevation */
        button {
            transition: all 0.3s cubic-bezier(.25,.8,.25,1); /* Material ease-out curve */
            box-shadow: 0 3px 1px -2px rgba(0,0,0,.2), 0 2px 2px 0 rgba(0,0,0,.14), 0 1px 5px 0 rgba(0,0,0,.12); /* Default Material shadow */
        }
        button:hover:not(:disabled) {
            transform: translateY(-1px); /* Slight lift */
            box-shadow: 0 5px 5px -3px rgba(0,0,0,.2), 0 8px 10px 1px rgba(0,0,0,.14), 0 3px 14px 2px rgba(0,0,0,.12); /* Stronger shadow on hover (Elevation 8) */
        }
        button:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 2px 4px -1px rgba(0,0,0,.2), 0 4px 5px 0 rgba(0,0,0,.14), 0 1px 10px 0 rgba(0,0,0,.12); /* Pressed effect (Elevation 2/4) */
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none; /* No shadow when disabled */
        }

        /* Kiểu cho các mục trong danh sách - Material Card-like */
        .list-item {
            transition: all 0.2s cubic-bezier(.25,.8,.25,1);
            border: 1px solid #e0e0e0; /* Add default subtle border */
            box-shadow: 0 2px 2px 0 rgba(0,0,0,.14), 0 3px 1px -2px rgba(0,0,0,.12), 0 1px 5px 0 rgba(0,0,0,.2); /* Default card shadow */
        }
        .list-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 5px 0 rgba(0,0,0,.14), 0 1px 10px 0 rgba(0,0,0,.12), 0 2px 4px -1px rgba(0,0,0,.2); /* Deeper shadow on hover */
            border-color: #90caf9; /* Blue-300 Material */
        }
        .list-item.selected {
             background-color: #e3f2fd; /* Blue-50 Material */
             border-left: 4px solid #1976d2; /* Blue-700 Material for active indicator */
             border-color: #90caf9; /* Blue-300 Material for overall border */
             box-shadow: 0 2px 2px 0 rgba(0,0,0,.14), 0 3px 1px -2px rgba(0,0,0,.12), 0 1px 5px 0 rgba(0,0,0,.2); /* Keep shadow for selected state */
        }
        
        /* Biểu tượng tải - Material Spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.4);
            border-left-color: #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* CSS cho Modal xem trước */
        #previewModal iframe {
            width: 100%; /* Giữ 100% so với container cha */
            height: 80vh;
            border: 1px solid #e0e0e0; /* Material gray border */
            border-radius: 0.5rem;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.06); /* Subtle inner shadow */
        }

        /* NEW: Styles for preview modes */
        #previewFrameContainer {
            transition: max-width 0.3s ease-in-out; /* Hiệu ứng chuyển đổi mượt mà */
            max-width: 100%; /* Mặc định là full width của modal */
            width: 100%; /* Đảm bảo nó chiếm đủ không gian theo max-width */
        }

        #previewFrameContainer.mobile-view {
            max-width: 375px; /* Chiều rộng điển hình cho thiết bị di động */
        }

        /* NEW: Styles for bigger desktop modal content */
        #previewModalContent {
            transition: max-width 0.3s ease-in-out, width 0.3s ease-in-out; /* Add width transition */
        }

        #previewModalContent.desktop-mode-active {
            max-width: 90vw; /* Take 90% of viewport width for desktop view */
            width: 90vw; /* Ensure it applies */
        }

        /* Thêm style cho trình soạn thảo mới */
        #editorContainer {
            min-height: 200px; /* Đảm bảo chiều cao tối thiểu cho trình soạn thảo */
        }
        #editableCodeContent {
            /* Đảm bảo nội dung có thể cuộn và trông giống textarea */
            outline: none; /* Bỏ viền focus mặc định */
            tab-size: 4; /* Kích thước tab */
            min-height: 100%; /* Ensure contenteditable takes full height */
            white-space: pre-wrap; /* Ensure wrapping within pre */
            word-break: break-all; /* Break long words */
            caret-color: #1e88e5; /* Material Blue-600 for caret */
        }
        /* Adjusted placeholder z-index to be lower than content for better interaction */
        #editorPlaceholder {
            z-index: 5; /* Lower than editableCodeContent's z-index */
        }
        #editableCodeContent[contenteditable="true"] {
            z-index: 10;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Phần Header - Material App Bar -->
    <header class="bg-indigo-700 text-white p-4 shadow-md flex justify-between items-center z-40">
        <h1 class="text-3xl font-bold">Version Control AI Canvas</h1>
        <div id="authStatus" class="flex items-center space-x-4">
            <span id="userEmailDisplay" class="text-lg font-medium hidden"></span>
            <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 hidden">
                Đăng xuất
            </button>
        </div>
    </header>

    <!-- Phần Đăng nhập / Đăng ký - Material Card -->
    <div id="authSection" class="flex-grow flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
            <h2 class="text-3xl font-bold mb-6 text-center text-gray-800">Đăng nhập / Đăng ký</h2>
            <div class="mb-4">
                <label for="emailInput" class="block text-gray-700 text-base font-bold mb-2">Email:</label>
                <input type="email" id="emailInput" placeholder="your@example.com" class="shadow-sm border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-500">
            </div>
            <div class="mb-6">
                <label for="passwordInput" class="block text-gray-700 text-base font-bold mb-2">Mật khẩu:</label>
                <input type="password" id="passwordInput" placeholder="********" class="shadow-sm border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-500">
            </div>
            <div class="flex flex-col sm:flex-row gap-4">
                <button id="loginBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-5 rounded-lg shadow-md flex-grow">
                    Đăng nhập
                </button>
                <button id="registerBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-5 rounded-lg shadow-md flex-grow">
                    Đăng ký
                </button>
            </div>
            <p class="text-red-500 text-sm mt-4 text-center" id="authErrorMsg"></p>
        </div>
    </div>

    <!-- Nội dung chính của ứng dụng (Ẩn cho đến khi đăng nhập) -->
    <main id="mainAppContent" class="flex-grow container mx-auto p-4 grid grid-cols-1 lg:grid-cols-12 gap-6 hidden">
        
        <!-- Cột trái: Danh sách ứng dụng (15%) -->
        <section class="bg-white p-6 rounded-lg shadow-md col-span-1 lg:col-span-2 flex flex-col border border-gray-200">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Applications</h2>
            <button id="addNewAppBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-5 rounded-lg shadow-md mb-4 w-full">
                Add New Application
            </button>
            <div class="my-4">
                <input type="text" id="searchInput" placeholder="Tìm kiếm ứng dụng..." class="shadow-sm border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-500">
            </div>
            <div id="applicationsList" class="space-y-3 flex-grow overflow-y-auto pr-2">
                <div class="text-gray-500 text-center py-4">Loading applications...</div>
            </div>
        </section>

        <!-- Cột giữa: Danh sách phiên bản (15%) -->
        <section class="bg-white p-6 rounded-lg shadow-md col-span-1 lg:col-span-2 flex flex-col border border-gray-200">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Versions for <span id="currentAppName" class="font-bold text-blue-600">No App Selected</span></h2>
            <button id="showDeletedVersionsBtn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-5 rounded-lg shadow-md mb-4 w-full">
                Xem phiên bản đã xóa
            </button>
            <div id="versionsList" class="space-y-3 flex-grow overflow-y-auto pr-2">
                <div class="text-gray-500 text-center py-4">Select an application to see versions.</div>
            </div>
        </section>

        <!-- Cột phải: AI Canvas (70%) - Refactored for better visuals -->
        <section class="bg-white p-8 rounded-xl shadow-xl col-span-1 lg:col-span-8 flex flex-col border border-gray-200">
            <h2 class="text-3xl font-bold mb-6 text-gray-800">AI Canvas</h2>
            
            <!-- Block 1: Files and Version Info -->
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mb-6">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">Tệp trong phiên bản đã chọn:</h3>
                <div id="versionFilesList" class="space-y-2 max-h-48 overflow-y-auto pr-2 border border-gray-300 p-3 rounded-lg bg-gray-50 mb-4">
                    <div class="text-gray-500 text-center py-2">Chọn một phiên bản để xem các tệp của nó.</div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="fileNameInput" class="block text-gray-700 text-base font-bold mb-2">Tên tệp:</label>
                        <input type="text" id="fileNameInput" placeholder="e.g., index.html" class="shadow-sm border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="versionNotesInput" class="block text-gray-700 text-base font-bold mb-2">Ghi chú phiên bản đã chọn:</label>
                        <div class="flex gap-2">
                            <input type="text" id="versionNotesInput" placeholder="Chưa chọn phiên bản" class="shadow-sm border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-500" disabled>
                            <button id="editVersionNotesBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-3 rounded-lg shadow-md flex-shrink-0" style="min-width: 80px;">Sửa</button>
                            <button id="saveEditedVersionNotesBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-3 rounded-lg shadow-md hidden flex-shrink-0" style="min-width: 80px;">Lưu</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Block 2: Code Editor -->
            <div class="flex-grow flex flex-col mb-6 bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                <!-- NEW: Flex container for label and copy button -->
                <div class="flex justify-between items-center mb-4">
                    <label for="editableCodeContent" class="block text-gray-700 text-base font-bold mb-0">Trình soạn thảo:</label>
                    <button id="copyBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg shadow-md flex-shrink-0 text-sm">
                        Sao chép mã
                    </button>
                </div>
                <div id="editorContainer" class="relative flex-grow shadow-inner border border-gray-300 rounded-lg overflow-hidden bg-gray-50">
                    <pre class="absolute inset-0 overflow-y-auto p-4 font-mono text-sm bg-gray-50 text-gray-800 leading-relaxed whitespace-pre-wrap z-10" style="tab-size: 4;"><code id="editableCodeContent" contenteditable="true" class="block min-h-full focus:outline-none" style="caret-color: #3b82f6;"></code></pre>
                    <div id="editorPlaceholder" class="absolute inset-0 p-4 font-mono text-sm text-gray-400 pointer-events-none z-5">Chọn một tệp, hoặc yêu cầu AI tạo code mới...</div>
                </div>
                <!-- Removed the old copy button div:
                <div class="mt-4 flex justify-end">
                    <button id="copyBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg shadow-md flex-shrink-0">
                        Sao chép mã
                    </button>
                </div>
                -->
            </div>

            <!-- Block 3: AI Explanation -->
            <div class="mb-6 bg-white p-6 rounded-xl shadow-lg border border-gray-200 border-l-4 border-purple-600">
                <label for="aiExplanationBox" class="block text-gray-700 text-base font-bold mb-2">Giải thích từ AI:</label>
                <div id="aiExplanationBox" class="w-full h-32 p-4 bg-purple-50 border border-purple-200 rounded-lg overflow-y-auto text-sm text-gray-700 leading-relaxed">
                    <p class="text-gray-500">Phần giải thích của AI sẽ xuất hiện ở đây...</p>
                </div>
            </div>

            <!-- NEW Block for Main Style Selection -->
            <div class="mb-6 bg-white p-6 rounded-xl shadow-lg border border-gray-200 border-l-4 border-blue-600">
                <label for="mainStyleSelect" class="block text-gray-700 text-base font-bold mb-2">Chọn Phong cách Chủ đạo cho AI:</label>
                <select id="mainStyleSelect" class="shadow-sm border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-500">
                    <option value="">Không có phong cách cụ thể (mặc định)</option>
                    <option value="Modern Minimalist">Hiện đại Tối giản (Modern Minimalist)</option>
                    <option value="Clean and Professional">Sạch sẽ và Chuyên nghiệp (Clean and Professional)</option>
                    <option value="Flat Design">Thiết kế phẳng (Flat Design)</option>
                    <option value="Material Design">Material Design (Google)</option>
                    <option value="Fluent Design">Fluent Design (Microsoft)</option>
                    <option value="Glassmorphism">Glassmorphism (Hiệu ứng kính mờ)</option>
                    <option value="Neumorphism">Neumorphism (Hiệu ứng nổi khối mềm)</option>
                    <option value="Brutalism">Brutalism (Thô ráp, ít trang trí)</option>
                    <option value="Dark Mode Aesthetic">Thẩm mỹ Chế độ Tối (Dark Mode Aesthetic)</option>
                    <option value="Gradient-focused">Tập trung Gradient</option>
                    <option value="Playful and Illustrative">Vui tươi và minh họa</option>
                    <option value="Retro/Vintage Modern">Retro/Vintage Hiện đại</option>
                    <option value="Skeuomorphic">Skeuomorphic (Mô phỏng vật lý)</option>
                    <option value="Futuristic Tech">Công nghệ Tương lai</option>
                </select>
            </div>
            
            <!-- Block 4: AI Prompt and Send Button -->
            <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-lg">
                 <label for="aiPromptInput" class="block text-gray-700 text-base font-bold mb-2">Yêu cầu cho AI:</label>
                 <textarea id="aiPromptInput" rows="3" class="shadow-sm border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-500" placeholder="e.g., 'Thêm bình luận cho hàm này' hoặc 'Tạo một nút bấm màu đỏ'"></textarea>
                 
                 <!-- NEW: AI Prompt Suggestions -->
                 <div class="mt-4">
                     <div class="flex items-center gap-2 mb-2">
                        <label class="block text-gray-700 text-sm font-bold">Gợi ý câu lệnh AI:</label>
                        <button id="toggleAiSuggestionsBtn" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 py-1 px-2 rounded-full">Ẩn</button>
                     </div>
                     <div id="aiPromptSuggestions" class="flex flex-wrap gap-2">
                         <!-- Suggestions will be injected here by JS -->
                     </div>
                 </div>

                 <button id="sendToAIButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-5 rounded-lg shadow-md mt-4 w-full flex items-center justify-center gap-2">
                    <span id="aiButtonText">Gửi tới AI</span>
                    <div id="aiButtonSpinner" class="spinner hidden"></div>
                </button>
            </div>

            <!-- Block 5: Action Buttons -->
            <div class="mt-6 p-6 bg-white rounded-xl border border-gray-200 shadow-lg">
                <!-- NEW INPUT FIELD FOR NEW VERSION NOTES -->
                <div class="mb-4">
                    <label for="newVersionNotesInput" class="block text-gray-700 text-base font-bold mb-2">Ghi chú cho phiên bản mới:</label>
                    <input type="text" id="newVersionNotesInput" placeholder="e.g., 'Refactored with AI'" class="shadow-sm border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-500">
                </div>
                <!-- END NEW INPUT FIELD -->

                 <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                     <button id="saveVersionBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-5 rounded-lg shadow-md w-full">
                        Lưu phiên bản mới
                    </button>
                    <button id="previewBtn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-5 rounded-lg shadow-md w-full">
                        Xem trước mã
                    </button>
                    <!-- NÚT XÓA (Soft Delete) -->
                    <button id="softDeleteVersionBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-5 rounded-lg shadow-md w-full">
                        Xóa phiên bản
                    </button>
                </div>
            </div>
        </section>
    </main>

    <!-- Hộp thông báo tùy chỉnh - Material Snackbar -->
    <div id="messageBox" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-xl hidden z-50 transition-opacity duration-300 opacity-0">
        <span id="messageContent"></span>
    </div>

    <!-- Modal để thêm ứng dụng mới - Material Dialog -->
    <div id="addNewAppModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-2xl font-bold mb-6 text-gray-800">Add New Application</h3>
            <div class="mb-4">
                <label for="newAppNameInput" class="block text-gray-700 text-base font-bold mb-2">Application Name:</label>
                <input type="text" id="newAppNameInput" placeholder="e.g., 'My Blog App'" class="shadow-sm border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-500">
            </div>
            <div class="flex justify-end gap-4">
                <button id="cancelNewAppBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">Cancel</button>
                <button id="confirmNewAppBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Add Application</button>
            </div>
        </div>
    </div>

    <!-- NEW: Modal để sửa tên ứng dụng - Material Dialog -->
    <div id="editAppModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-2xl font-bold mb-6 text-gray-800">Sửa tên ứng dụng</h3>
            <div class="mb-4">
                <label for="editAppNameInput" class="block text-gray-700 text-base font-bold mb-2">Tên ứng dụng:</label>
                <input type="text" id="editAppNameInput" class="shadow-sm border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-500">
            </div>
            <div class="flex justify-end gap-4">
                <button id="cancelEditAppBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">Hủy</button>
                <button id="confirmEditAppBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Lưu</button>
            </div>
        </div>
    </div>

    <!-- MODAL XEM TRƯỚC - Material Dialog -->
    <div id="previewModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div id="previewModalContent" class="bg-white rounded-lg shadow-2xl w-full max-w-4xl flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-gray-200">
                <h3 class="text-xl font-semibold">Bản xem trước</h3>
                <!-- NEW: Preview Mode Buttons (Toggle Chips) moved here -->
                <div class="flex space-x-2">
                    <button id="mobileViewBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-full transition duration-300 shadow-sm">
                        Chế độ di động
                    </button>
                    <button id="desktopViewBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-full transition duration-300 shadow-sm">
                        Chế độ desktop
                    </button>
                </div>
                <button id="closePreviewBtn" class="text-gray-500 hover:text-gray-800 text-3xl font-bold">&times;</button>
            </div>
            <div class="p-4 flex flex-col items-center">
                <!-- Container for the iframe to control its width -->
                <div id="previewFrameContainer" class="w-full">
                    <iframe id="previewFrame" title="Preview Content"></iframe>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL PHIÊN BẢN ĐÃ XÓA MỚI - Material Dialog -->
    <div id="deletedVersionsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <h3 class="text-2xl font-bold mb-6 text-gray-800">Phiên bản đã xóa</h3>
            <div id="deletedVersionsList" class="space-y-3 flex-grow overflow-y-auto pr-2">
                <div class="text-gray-500 text-center py-4">Đang tải các phiên bản đã xóa...</div>
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button id="closeDeletedVersionsModalBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">Đóng</button>
            </div>
        </div>
    </div>


    <!-- highlight.js JS - Đã di chuyển lên đây để đảm bảo tải trước script module -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <!-- Firebase SDK và script tùy chỉnh -->
    <script type="module">
        // Import các module cần thiết từ Firebase (sử dụng phiên bản 12.0.0 như code gốc)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, getDocs, getDoc, onSnapshot, query, orderBy, setDoc, updateDoc, deleteDoc, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
        
        // **QUAY LẠI SỬ DỤNG FIREBASE AI SDK NHƯ CODE GỐC**
        import { getAI, getGenerativeModel, GoogleAIBackend } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-ai.js";

        // --- Cấu hình Firebase ---
        // LƯU Ý QUAN TRỌNG: Thay thế các giá trị dưới đây bằng cấu hình Firebase của chính bạn.
        const firebaseConfig = {
            apiKey: "AIzaSyD7I9ZKYFTc71tFMGA2lM72ykwDuwhEV0o",
            authDomain: "tudien-b2d17.firebaseapp.com",
            projectId: "tudien-b2d17",
            storageBucket: "tudien-b2d17.firebasestorage.app",
            messagingSenderId: "496472238606",
            appId: "1:496472238606:web:79769d3c38e546a27dea5f"
        };

        // --- Khởi tạo Firebase ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- Khởi tạo AI Model thông qua Firebase AI SDK ---
        let aiModel;
        try {
            const ai = getAI(app, { backend: new GoogleAIBackend() });
            aiModel = getGenerativeModel(ai, { model: "gemini-2.5-flash" });
            console.log("Generative Model initialized successfully via Firebase AI SDK.");
        } catch (e) {
            console.error("Error initializing AI Model:", e);
            showMessage("Lỗi khởi tạo AI Model. Kiểm tra Console.", 5000);
        }

        // --- Biến toàn cục và tham chiếu DOM ---
        let currentAppId = null;
        let currentAppName = null;
        let currentVersionId = null; 
        let userId = null;
        let allApps = []; // Cache all apps for filtering
        let chat = null; // **BIẾN MỚI: Lưu trữ phiên trò chuyện với AI**
        let currentVersionFiles = new Map(); // Store files for the currently selected version to avoid re-fetching

        // DOM References
        const elements = {
            // Auth
            authSection: document.getElementById('authSection'),
            mainAppContent: document.getElementById('mainAppContent'),
            emailInput: document.getElementById('emailInput'),
            passwordInput: document.getElementById('passwordInput'),
            loginBtn: document.getElementById('loginBtn'),
            registerBtn: document.getElementById('registerBtn'),
            logoutBtn: document.getElementById('logoutBtn'),
            userEmailDisplay: document.getElementById('userEmailDisplay'),
            authErrorMsg: document.getElementById('authErrorMsg'),
            // App & Version Lists
            applicationsList: document.getElementById('applicationsList'),
            versionsList: document.getElementById('versionsList'),
            currentAppNameSpan: document.getElementById('currentAppName'),
            searchInput: document.getElementById('searchInput'),
            // AI Canvas & Editor
            versionFilesList: document.getElementById('versionFilesList'),
            fileNameInput: document.getElementById('fileNameInput'),
            versionNotesInput: document.getElementById('versionNotesInput'), // repurposed
            editVersionNotesBtn: document.getElementById('editVersionNotesBtn'),
            saveEditedVersionNotesBtn: document.getElementById('saveEditedVersionNotesBtn'),
            newVersionNotesInput: document.getElementById('newVersionNotesInput'), // new input for new version
            editorContainer: document.getElementById('editorContainer'),
            editableCodeContent: document.getElementById('editableCodeContent'),
            editorPlaceholder: document.getElementById('editorPlaceholder'),
            aiPromptInput: document.getElementById('aiPromptInput'),
            sendToAIButton: document.getElementById('sendToAIButton'),
            aiButtonText: document.getElementById('aiButtonText'),
            aiButtonSpinner: document.getElementById('aiButtonSpinner'),
            aiExplanationBox: document.getElementById('aiExplanationBox'),
            aiPromptSuggestionsContainer: document.getElementById('aiPromptSuggestions'),
            toggleAiSuggestionsBtn: document.getElementById('toggleAiSuggestionsBtn'), // NEW: Toggle button for AI suggestions
            mainStyleSelect: document.getElementById('mainStyleSelect'), // NEW: Reference to main style select
            // Actions
            saveVersionBtn: document.getElementById('saveVersionBtn'),
            copyBtn: document.getElementById('copyBtn'),
            previewBtn: document.getElementById('previewBtn'),
            softDeleteVersionBtn: document.getElementById('softDeleteVersionBtn'),
            // Modals & Messages
            messageBox: document.getElementById('messageBox'),
            messageContent: document.getElementById('messageContent'),
            addNewAppBtn: document.getElementById('addNewAppBtn'),
            addNewAppModal: document.getElementById('addNewAppModal'),
            newAppNameInput: document.getElementById('newAppNameInput'),
            confirmNewAppBtn: document.getElementById('confirmNewAppBtn'),
            cancelNewAppBtn: document.getElementById('cancelNewAppBtn'),
            previewModal: document.getElementById('previewModal'),
            closePreviewBtn: document.getElementById('closePreviewBtn'),
            previewFrame: document.getElementById('previewFrame'),
            showDeletedVersionsBtn: document.getElementById('showDeletedVersionsBtn'),
            deletedVersionsModal: document.getElementById('deletedVersionsModal'),
            deletedVersionsList: document.getElementById('deletedVersionsList'),
            closeDeletedVersionsModalBtn: document.getElementById('closeDeletedVersionsModalBtn'),
            // NEW: Preview mode elements
            mobileViewBtn: document.getElementById('mobileViewBtn'),
            desktopViewBtn: document.getElementById('desktopViewBtn'),
            previewFrameContainer: document.getElementById('previewFrameContainer'),
            previewModalContent: document.getElementById('previewModalContent'), // NEW: Add this
            // NEW: Edit App Modal elements
            editAppModal: document.getElementById('editAppModal'),
            editAppNameInput: document.getElementById('editAppNameInput'),
            confirmEditAppBtn: document.getElementById('confirmEditAppBtn'),
            cancelEditAppBtn: document.getElementById('cancelEditAppBtn'),
        };

        const mainCodeEditor = elements.editableCodeContent; // Map lại biến cũ `mainCodeEditor` vào element mới

        const aiPromptSuggestions = [
            "Tạo cho tôi một ứng dụng web viết bằng html tích hợp js và css. Giao diện TailwindCss hiện đại. Nội dung của nó là:",
            "Thêm CSS để căn giữa nội dung trang và đặt màu nền là màu xanh nhạt (#e0f7fa).",
            "Viết JavaScript để khi click nút 'Click me' sẽ hiển thị thông báo 'Bạn đã click!'",
            "Giải thích đoạn mã HTML/CSS/JS này hoạt động như thế nào.",
            "Tối ưu hóa mã nguồn này để nó chạy nhanh hơn và dễ đọc hơn."
        ];

        // --- highlight.js script ---
        function applyHighlighting() {
            if (typeof hljs === 'undefined') return;

            // Xóa tất cả các lớp ngôn ngữ cũ để tránh xung đột
            mainCodeEditor.className = mainCodeEditor.className.split(' ')
                                     .filter(cls => !cls.startsWith('language-'))
                                     .join(' ');

            const filename = elements.fileNameInput.value.trim();
            let langClass = '';

            // Gán lớp ngôn ngữ dựa trên phần mở rộng của tên tệp
            if (filename.endsWith('.html') || filename.endsWith('.htm')) {
                langClass = 'language-xml'; // highlight.js sử dụng 'xml' cho HTML
            } else if (filename.endsWith('.css')) {
                langClass = 'language-css';
            } else if (filename.endsWith('.js') || filename.endsWith('.json')) {
                langClass = 'language-javascript'; // hoặc 'json'
            } else {
                // Mặc định là HTML (xml) hoặc văn bản thuần nếu không có phần mở rộng cụ thể
                // Thường thì AI sẽ trả về hỗn hợp HTML/JS/CSS, nên 'xml' là một lựa chọn chung tốt.
                langClass = 'language-xml'; 
            }
            
            if (langClass) {
                mainCodeEditor.classList.add(langClass);
            }

            hljs.highlightElement(mainCodeEditor); 
        }

        // --- Hàm tiện ích ---
        function showMessage(message, duration = 3000) {
            elements.messageContent.textContent = message;
            elements.messageBox.classList.remove('hidden', 'opacity-0');
            elements.messageBox.classList.add('opacity-100');
            setTimeout(() => {
                elements.messageBox.classList.remove('opacity-100');
                elements.messageBox.classList.add('opacity-0');
                setTimeout(() => elements.messageBox.classList.add('hidden'), 300);
            }, duration);
        }

        function showAuthError(message) {
            elements.authErrorMsg.textContent = message;
        }

        // --- Logic Placeholder cho trình soạn thảo ---
        function toggleEditorPlaceholder() {
            if (mainCodeEditor.textContent.trim() === '') {
                elements.editorPlaceholder.style.display = 'block';
            } else {
                elements.editorPlaceholder.style.display = 'none';
            }
        }

        // NEW: Hàm render gợi ý câu lệnh AI
        function renderAiPromptSuggestions() {
            elements.aiPromptSuggestionsContainer.innerHTML = '';
            const fragment = document.createDocumentFragment();
            aiPromptSuggestions.forEach(prompt => {
                const button = document.createElement('button');
                button.textContent = prompt;
                button.className = 'bg-blue-100 hover:bg-blue-200 text-blue-800 text-xs py-1 px-3 rounded-full transition duration-200 cursor-pointer border border-blue-200 whitespace-nowrap overflow-hidden text-ellipsis shadow-sm';
                button.title = prompt;
                button.dataset.prompt = prompt; // Use dataset for click handler
                fragment.appendChild(button);
            });
            elements.aiPromptSuggestionsContainer.appendChild(fragment);
        }

        // NEW: Hàm ẩn/hiện gợi ý AI
        function toggleAiSuggestions() {
            elements.aiPromptSuggestionsContainer.classList.toggle('hidden');
            if (elements.aiPromptSuggestionsContainer.classList.contains('hidden')) {
                elements.toggleAiSuggestionsBtn.textContent = 'Hiện';
            } else {
                elements.toggleAiSuggestionsBtn.textContent = 'Ẩn';
            }
        }

        // --- Xác thực Firebase ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                elements.userEmailDisplay.textContent = user.email || "Anonymous";
                elements.userEmailDisplay.classList.remove('hidden');
                elements.logoutBtn.classList.remove('hidden');
                elements.authSection.classList.add('hidden');
                elements.mainAppContent.classList.remove('hidden');
                elements.mainAppContent.classList.add('grid');
                loadApplications();
                toggleEditorPlaceholder();
                renderAiPromptSuggestions();
            } else {
                userId = null;
                elements.userEmailDisplay.classList.add('hidden');
                elements.logoutBtn.classList.add('hidden');
                elements.authSection.classList.remove('hidden');
                elements.mainAppContent.classList.add('hidden');
                elements.mainAppContent.classList.remove('grid');
            }
        });

        // --- Các hàm xác thực ---
        const handleAuth = async (isRegister) => {
            const email = elements.emailInput.value.trim();
            const password = elements.passwordInput.value.trim();
            if (!email || !password) {
                return showAuthError("Vui lòng nhập email và mật khẩu.");
            }
            try {
                if (isRegister) {
                    await createUserWithEmailAndPassword(auth, email, password);
                    showMessage("Đăng ký thành công!");
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                    showMessage("Đăng nhập thành công!");
                }
                showAuthError(''); // Clear error message on success
            } catch (error) {
                showAuthError(error.message);
            }
        };

        const handleLogout = () => signOut(auth).then(() => showMessage("Đã đăng xuất."));

        // --- Logic Firestore ---
        const getCollections = {
            applications: () => collection(db, `users/${userId}/applications`),
            versions: (appId) => collection(db, `users/${userId}/applications/${appId}/versions`),
            files: (appId, versionId) => collection(db, `users/${userId}/applications/${appId}/versions/${versionId}/files`)
        };

        const getFilesForVersion = async (appId, versionId) => {
            const files = new Map();
            let currentId = versionId;
            while (currentId) {
                const versionRef = doc(db, `users/${userId}/applications/${appId}/versions/${currentId}`);
                const versionSnap = await getDoc(versionRef);
                if (!versionSnap.exists()) break;
                const versionData = versionSnap.data();
                
                const filesQuery = query(getCollections.files(appId, currentId));
                const filesSnapshot = await getDocs(filesQuery);
                filesSnapshot.forEach(fileDoc => {
                    const fileData = fileDoc.data();
                    if (!files.has(fileData.filename)) {
                        files.set(fileData.filename, { ...fileData, id: fileDoc.id, versionId: currentId });
                    }
                });

                currentId = versionData.parentVersionId || null;
            }
            return files;
        };

        // --- Các hàm render giao diện ---
        const renderApplications = (appsToRender) => {
            elements.applicationsList.innerHTML = '';
            if (appsToRender.length === 0) {
                elements.applicationsList.innerHTML = '<div class="text-gray-500 text-center py-4">Chưa có ứng dụng nào.</div>';
                return;
            }
            const fragment = document.createDocumentFragment();
            appsToRender.forEach((appData, index) => {
                const appItem = document.createElement('div');
                appItem.className = 'list-item bg-white p-3 rounded-lg cursor-pointer transition duration-200 shadow-sm flex justify-between items-center';
                if (appData.id === currentAppId) appItem.classList.add('selected');
                appItem.dataset.appId = appData.id;
                appItem.dataset.appName = appData.name;
                appItem.innerHTML = `
                    <div class="flex-grow font-medium text-gray-700 overflow-hidden text-ellipsis whitespace-nowrap">${index + 1}. ${appData.name}</div>
                    <div class="flex-shrink-0 flex gap-0.5">
                        <button class="edit-app-btn bg-yellow-600 hover:bg-yellow-700 text-white text-xs font-bold py-0.5 px-1.5 rounded-md transition duration-200 shadow-sm" title="Sửa">Sửa</button>
                        <button class="delete-app-btn bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-0.5 px-1.5 rounded-md transition duration-200 shadow-sm" title="Xóa">Xóa</button>
                    </div>
                `;
                fragment.appendChild(appItem);
            });
            elements.applicationsList.appendChild(fragment);
        };

        const loadApplications = () => {
            if (!userId) return;
            const q = query(getCollections.applications(), orderBy('createdAt', 'desc'));
            onSnapshot(q, (snapshot) => {
                allApps = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderApplications(allApps);
            }, (error) => console.error("Error loading applications:", error));
        };

        const selectApplication = (appId, appName) => {
            currentAppId = appId;
            currentAppName = appName;
            currentVersionId = null;
            chat = null;
            currentVersionFiles.clear(); // Clear cached files

            elements.currentAppNameSpan.textContent = appName; // FIX: Update app name display

            document.querySelectorAll('#applicationsList > div').forEach(el => el.classList.remove('selected'));
            document.querySelector(`#applicationsList [data-app-id="${appId}"]`)?.classList.add('selected');

            loadVersions(appId);
            mainCodeEditor.textContent = '';
            applyHighlighting();
            toggleEditorPlaceholder();
            elements.fileNameInput.value = '';
            elements.versionNotesInput.value = ''; // Clear selected version notes
            elements.versionNotesInput.disabled = true; // Disable it
            elements.editVersionNotesBtn.classList.remove('hidden'); // Show edit
            elements.saveEditedVersionNotesBtn.classList.add('hidden'); // Hide save
            elements.newVersionNotesInput.value = ''; // Clear new version notes
            elements.versionFilesList.innerHTML = '<div class="text-gray-500 text-center py-2">Chọn một phiên bản để xem tệp.</div>';
            elements.aiExplanationBox.innerHTML = '<p class="text-gray-500">Phần giải thích của AI sẽ xuất hiện ở đây...</p>';
            elements.aiPromptInput.value = '';
        };

        const loadVersions = (appId) => {
            if (!userId || !appId) return;
            const q = query(getCollections.versions(appId), where('deleted', '!=', true), orderBy('timestamp', 'desc'));
            onSnapshot(q, (snapshot) => {
                elements.versionsList.innerHTML = '';
                if (snapshot.empty) {
                    elements.versionsList.innerHTML = '<div class="text-gray-500 text-center py-4">Chưa có phiên bản nào.</div>';
                    return;
                }
                const fragment = document.createDocumentFragment();
                snapshot.forEach(doc => {
                    const version = doc.data();
                    const versionItem = document.createElement('div');
                    versionItem.className = 'list-item bg-white p-3 rounded-lg cursor-pointer transition duration-200 shadow-sm';
                    if (doc.id === currentVersionId) versionItem.classList.add('selected');
                    const date = new Date(version.timestamp).toLocaleString();
                    versionItem.innerHTML = `
                        <p class="font-medium text-gray-700">Phiên bản: ${version.versionIndex || 'N/A'}</p>
                        <p class="text-sm text-gray-500">${version.notes || 'Không có ghi chú'}</p>
                        <p class="text-xs text-gray-400">${date}</p>`;
                    versionItem.dataset.versionId = doc.id;
                    fragment.appendChild(versionItem);
                });
                elements.versionsList.appendChild(fragment);
            });
        };

        const selectVersion = async (appId, versionId) => {
            currentVersionId = versionId;
            chat = null; // Reset chat session
            elements.aiPromptInput.value = ''; // Reset AI prompt input

            document.querySelectorAll('#versionsList > div').forEach(el => el.classList.remove('selected'));
            document.querySelector(`#versionsList [data-version-id="${versionId}"]`)?.classList.add('selected');

            elements.versionFilesList.innerHTML = '<div class="text-gray-500 text-center py-2">Đang tải tệp...</div>';
            elements.aiExplanationBox.innerHTML = '<p class="text-gray-500">Phần giải thích của AI sẽ xuất hiện ở đây...</p>';

            try {
                // Fetch version notes first
                const versionRef = doc(db, `users/${userId}/applications/${appId}/versions/${versionId}`);
                const versionSnap = await getDoc(versionRef);
                if (versionSnap.exists()) {
                    const versionData = versionSnap.data();
                    elements.versionNotesInput.value = versionData.notes || 'Không có ghi chú';
                } else {
                    elements.versionNotesInput.value = 'Phiên bản không tồn tại.';
                }
                elements.versionNotesInput.disabled = true; // Make it disabled by default
                elements.editVersionNotesBtn.classList.remove('hidden'); // Show edit button
                elements.saveEditedVersionNotesBtn.classList.add('hidden'); // Hide save button

                elements.newVersionNotesInput.value = ''; // Clear new version notes input when selecting existing version.

                // Existing file loading logic...
                currentVersionFiles = await getFilesForVersion(appId, versionId);
                elements.versionFilesList.innerHTML = '';
                if (currentVersionFiles.size > 0) {
                    const sortedFiles = Array.from(currentVersionFiles.values()).sort((a, b) => a.filename.localeCompare(b.filename));
                    const fragment = document.createDocumentFragment();
                    sortedFiles.forEach(fileData => {
                        const fileItem = document.createElement('div');
                        fileItem.className = 'list-item bg-white p-2 rounded-lg cursor-pointer transition duration-200 shadow-sm text-sm';
                        fileItem.textContent = fileData.filename;
                        fileItem.dataset.filename = fileData.filename; // Store filename for click delegation
                        fragment.appendChild(fileItem);
                    });
                    elements.versionFilesList.appendChild(fragment);
                } else {
                    elements.versionFilesList.innerHTML = '<div class="text-gray-500 text-center py-2">Không tìm thấy tệp nào.</div>';
                }
            }
            catch (error) {
                console.error("Error loading files or version notes for version:", error);
                elements.versionFilesInput.value = '<div class="text-red-500 text-center py-2">Lỗi khi tải tệp.</div>';
                elements.versionNotesInput.value = 'Lỗi khi tải ghi chú.';
            }
        };

        const loadFileIntoEditor = (filename) => {
            const fileData = currentVersionFiles.get(filename);
            if (fileData) {
                elements.fileNameInput.value = fileData.filename;
                mainCodeEditor.textContent = fileData.content;
                applyHighlighting();
                toggleEditorPlaceholder();
                showMessage(`Đã tải ${fileData.filename} vào trình soạn thảo.`);
                chat = null;
                elements.aiExplanationBox.innerHTML = '<p class="text-gray-500">Phần giải thích của AI sẽ xuất hiện ở đây...</p>';
            }
        };

        // --- Logic AI Canvas (Sử dụng Firebase AI SDK với ngữ cảnh hội thoại) ---
        const callAI = async () => {
            if (!aiModel) {
                return showMessage("Mô hình AI chưa sẵn sàng.", 3000);
            }
            const userPrompt = elements.aiPromptInput.value.trim();
            if (!userPrompt) return showMessage("Vui lòng nhập yêu cầu cho AI.");

            elements.aiButtonText.textContent = 'AI đang tạo code cho bạn... vui lòng đợi tới khi hoàn thành';
            elements.aiButtonSpinner.classList.remove('hidden');
            elements.sendToAIButton.disabled = true;

            try {
                const selectedStyle = elements.mainStyleSelect.value;
                let instruction = `Bạn là một trợ lý lập trình chuyên nghiệp. Hãy trả lời theo định dạng sau: Đầu tiên, đưa ra lời giải thích ngắn gọn. Sau đó, thêm một dòng chỉ chứa dấu phân cách '---CODE---'. Cuối cùng, chỉ cung cấp khối mã hoàn chỉnh, sạch sẽ mà không có bất kỳ định dạng markdown nào khác.`;

                if (selectedStyle) {
                    instruction += ` Khi tạo mã, hãy cố gắng tuân thủ phong cách thiết kế "${selectedStyle}".`;
                }

                if (!chat) {
                    const currentCode = mainCodeEditor.textContent;
                    const history = [
                        {
                            role: "user",
                            parts: [{ text: `${instruction}\n\nMã nguồn ban đầu để làm việc là:\n---\n${currentCode}` }],
                        },
                        {
                            role: "model",
                            parts: [{ text: "Đã hiểu. Tôi đã nhận được mã nguồn và sẽ tuân theo định dạng được yêu cầu. Yêu cầu của bạn là gì?" }],
                        }
                    ];
                    chat = aiModel.startChat({ history });
                }

                const result = await chat.sendMessage(userPrompt);
                const fullResponseText = result.response.text();

                const separator = '---CODE---';
                let explanation = "AI không cung cấp giải thích cho lần này.";
                let code = fullResponseText;

                if (fullResponseText.includes(separator)) {
                    const parts = fullResponseText.split(separator);
                    explanation = parts[0].trim();
                    code = parts.slice(1).join(separator).trim();
                }
                
                elements.aiExplanationBox.innerHTML = explanation.replace(/\n/g, '<br>');
                mainCodeEditor.textContent = code;
                applyHighlighting();
                toggleEditorPlaceholder();
                elements.aiPromptInput.value = '';
                showMessage("AI đã cập nhật mã và cung cấp giải thích.");

            } catch (error) {
                console.error("Error calling AI via Firebase:", error);
                showMessage(`Lỗi khi gọi AI: ${error.message}`, 5000);
                chat = null;
            } finally {
                elements.aiButtonText.textContent = 'Gửi tới AI';
                elements.aiButtonSpinner.classList.add('hidden');
                elements.sendToAIButton.disabled = false;
            }
        };

        // --- Các hàm hành động ---
        const saveVersion = async () => {
            if (!userId || !currentAppId) return showMessage('Vui lòng chọn một ứng dụng.');
            const filename = elements.fileNameInput.value.trim();
            const content = mainCodeEditor.textContent;
            const newVersionNotes = elements.newVersionNotesInput.value.trim(); // Use the new input for new version notes
            
            if (!filename || !content) return showMessage(`Tên tệp và nội dung không được để trống.`);

            try {
                const versionsQuery = query(getCollections.versions(currentAppId), where('deleted', '!=', true));
                const versionsSnapshot = await getDocs(versionsQuery);
                const newVersionIndex = versionsSnapshot.size + 1;

                const newVersionRef = await addDoc(getCollections.versions(currentAppId), {
                    versionIndex: newVersionIndex,
                    notes: newVersionNotes || 'Không có ghi chú', // Use new notes input
                    timestamp: Date.now(),
                    parentVersionId: currentVersionId,
                    deleted: false
                });

                await addDoc(getCollections.files(currentAppId, newVersionRef.id), {
                    filename,
                    content
                });
                
                showMessage('Phiên bản mới đã được lưu thành công!');
                mainCodeEditor.textContent = '';
                applyHighlighting();
                toggleEditorPlaceholder();
                elements.fileNameInput.value = '';
                elements.newVersionNotesInput.value = ''; // Clear this input after saving
                // Note: elements.versionNotesInput is for selected version, so it's not cleared here.
                elements.aiPromptInput.value = '';
                elements.aiExplanationBox.innerHTML = '<p class="text-gray-500">Phần giải thích của AI sẽ xuất hiện ở đây...</p>';
            } catch (error) {
                console.error("Error saving version:", error);
                showMessage('Lưu phiên bản thất bại.', 5000);
            }
        };

        const addNewApplication = async () => {
            if (!userId) return showMessage('Vui lòng đăng nhập để thêm ứng dụng.');
            const appName = elements.newAppNameInput.value.trim();
            if (!appName) return showMessage('Tên ứng dụng không được để trống.');
            try {
                await addDoc(getCollections.applications(), { 
                    name: appName, 
                    createdAt: Date.now()
                });
                showMessage(`Ứng dụng "${appName}" đã được thêm!`);
                hideAddNewAppModal();
            }
            catch (error) {
                console.error("Error adding new application:", error);
                showMessage('Thêm ứng dụng mới thất bại.', 5000);
            }
        };
        
        const showAddNewAppModal = () => {
            if (!userId) return showMessage('Vui lòng đăng nhập để thêm ứng dụng.');
            elements.newAppNameInput.value = '';
            elements.addNewAppModal.classList.remove('hidden');
        };

        const hideAddNewAppModal = () => elements.addNewAppModal.classList.add('hidden');

        // NEW: Function to handle setting the preview mode
        const setPreviewMode = (mode) => {
            if (mode === 'mobile') {
                elements.previewFrameContainer.classList.add('mobile-view');
                elements.previewModalContent.classList.remove('desktop-mode-active'); // NEW: Remove desktop size class

                elements.mobileViewBtn.classList.remove('bg-gray-200', 'text-gray-800');
                elements.mobileViewBtn.classList.add('bg-indigo-600', 'text-white');
                elements.desktopViewBtn.classList.remove('bg-indigo-600', 'text-white');
                elements.desktopViewBtn.classList.add('bg-gray-200', 'text-gray-800');
            } else { // 'desktop'
                elements.previewFrameContainer.classList.remove('mobile-view');
                elements.previewModalContent.classList.add('desktop-mode-active'); // NEW: Add desktop size class

                elements.desktopViewBtn.classList.remove('bg-gray-200', 'text-gray-800');
                elements.desktopViewBtn.classList.add('bg-indigo-600', 'text-white');
                elements.mobileViewBtn.classList.remove('bg-indigo-600', 'text-white');
                elements.mobileViewBtn.classList.add('bg-gray-200', 'text-gray-800');
            }
            // Tùy chọn: re-assign srcdoc để ép iframe refresh nếu cần thiết,
            // nhưng thường thì thay đổi CSS không cần điều này.
            // elements.previewFrame.srcdoc = elements.previewFrame.srcdoc; 
        };

        const showPreview = () => {
            const codeToPreview = mainCodeEditor.textContent;
            if (!codeToPreview) {
                return showMessage("Không có mã trong trình soạn thảo để xem trước.", 3000);
            }
            elements.previewFrame.srcdoc = codeToPreview;
            elements.previewModal.classList.remove('hidden');
            // Set default view to desktop when modal opens
            setPreviewMode('desktop'); 
        };

        const closePreview = () => {
            elements.previewModal.classList.add('hidden');
            elements.previewFrame.srcdoc = '';
        };


        const copyCode = () => {
            const codeToCopy = mainCodeEditor.textContent;
            if (!codeToCopy) {
                return showMessage("Không có mã trong trình soạn thảo để sao chép.", 3000);
            }
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = codeToCopy;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            document.execCommand('copy');
            document.body.removeChild(tempTextArea);
            showMessage('Mã đã được sao chép vào clipboard!');
        };

        // NEW: Edit and Save functions for selected version notes
        const editSelectedVersionNotes = () => {
            if (!currentVersionId) {
                return showMessage('Vui lòng chọn một phiên bản để sửa ghi chú.', 3000);
            }
            elements.versionNotesInput.disabled = false;
            elements.editVersionNotesBtn.classList.add('hidden');
            elements.saveEditedVersionNotesBtn.classList.remove('hidden');
            elements.versionNotesInput.focus();
        };

        const saveEditedVersionNotes = async () => {
            if (!userId || !currentAppId || !currentVersionId) {
                return showMessage('Không thể lưu. Vui lòng chọn một phiên bản.', 3000);
            }
            const newNotes = elements.versionNotesInput.value.trim();
            if (!newNotes) {
                return showMessage('Ghi chú không được để trống.', 3000);
            }

            try {
                const versionRef = doc(db, `users/${userId}/applications/${currentAppId}/versions/${currentVersionId}`);
                await updateDoc(versionRef, {
                    notes: newNotes,
                    timestamp: Date.now() // Update timestamp to reflect change, optional
                });
                showMessage('Ghi chú phiên bản đã được cập nhật!');
                elements.versionNotesInput.disabled = true;
                elements.editVersionNotesBtn.classList.remove('hidden');
                elements.saveEditedVersionNotesBtn.classList.add('hidden');
            } catch (error) {
                console.error("Error saving edited version notes:", error);
                showMessage(`Lỗi khi lưu ghi chú: ${error.message}`, 5000);
            }
        };

        // NEW: Edit Application Functions
        let appToEditId = null;

        const showEditAppModal = (appId, appName) => {
            if (!userId) return showMessage('Vui lòng đăng nhập để sửa ứng dụng.');
            appToEditId = appId;
            elements.editAppNameInput.value = appName;
            elements.editAppModal.classList.remove('hidden');
            elements.editAppNameInput.focus();
        };

        const hideEditAppModal = () => {
            appToEditId = null;
            elements.editAppModal.classList.add('hidden');
        };

        const saveEditedApplicationName = async () => {
            if (!userId || !appToEditId) return;
            const newName = elements.editAppNameInput.value.trim();
            if (!newName) return showMessage('Tên ứng dụng không được để trống.');

            try {
                const appRef = doc(db, `users/${userId}/applications/${appToEditId}`);
                await updateDoc(appRef, {
                    name: newName
                });
                showMessage(`Ứng dụng "${newName}" đã được cập nhật!`);
                hideEditAppModal();
                // If the currently selected app was edited, update its display
                if (currentAppId === appToEditId) {
                    elements.currentAppNameSpan.textContent = newName;
                }
            } catch (error) {
                console.error("Error updating application name:", error);
                showMessage('Cập nhật tên ứng dụng thất bại.', 5000);
            }
        };

        // NEW: Delete Application Functions (Cascading Delete)
        const deleteApplicationCascade = async (appId) => {
            if (!userId || !appId) return;

            if (!confirm('CẢNH BÁO: Bạn có chắc chắn muốn XÓA ỨNG DỤNG NÀY VĨNH VIỄN? Hành động này sẽ xóa TẤT CẢ các phiên bản và tệp liên quan đến ứng dụng này, và không thể hoàn tác.')) {
                return;
            }

            try {
                showMessage('Đang xóa ứng dụng và tất cả dữ liệu liên quan...', 0); // Show persistent message

                // 1. Get all versions for the app
                const versionsRef = getCollections.versions(appId);
                const versionsSnapshot = await getDocs(versionsRef);

                const deletePromises = [];

                // 2. For each version, get and delete all files, then delete the version
                for (const versionDoc of versionsSnapshot.docs) {
                    const versionId = versionDoc.id;
                    const filesRef = getCollections.files(appId, versionId);
                    const filesSnapshot = await getDocs(filesRef);

                    filesSnapshot.forEach((fileDoc) => {
                        deletePromises.push(deleteDoc(fileDoc.ref));
                    });
                    deletePromises.push(deleteDoc(versionDoc.ref)); // Delete the version itself
                }

                await Promise.all(deletePromises); // Wait for all files and versions to be deleted

                // 3. Finally, delete the application document itself
                await deleteDoc(doc(db, `users/${userId}/applications/${appId}`));

                showMessage('Ứng dụng và tất cả dữ liệu liên quan đã được xóa vĩnh viễn!');

                // Reset UI if the deleted app was currently selected
                if (currentAppId === appId) {
                    currentAppId = null;
                    currentAppName = null;
                    currentVersionId = null;
                    chat = null;
                    currentVersionFiles.clear();

                    elements.currentAppNameSpan.textContent = "No App Selected";
                    mainCodeEditor.textContent = '';
                    applyHighlighting();
                    toggleEditorPlaceholder();
                    elements.fileNameInput.value = '';
                    elements.versionNotesInput.value = '';
                    elements.versionNotesInput.disabled = true;
                    elements.editVersionNotesBtn.classList.remove('hidden');
                    elements.saveEditedVersionNotesBtn.classList.add('hidden');
                    elements.newVersionNotesInput.value = '';
                    elements.versionFilesList.innerHTML = '<div class="text-gray-500 text-center py-2">Chọn một ứng dụng và phiên bản để xem tệp.</div>';
                    elements.aiExplanationBox.innerHTML = '<p class="text-gray-500">Phần giải thích của AI sẽ xuất hiện ở đây...</p>';
                    elements.aiPromptInput.value = '';
                    elements.versionsList.innerHTML = '<div class="text-gray-500 text-center py-4">Chọn một ứng dụng để xem phiên bản.</div>';
                }

                // loadApplications() will be triggered by onSnapshot automatically

            } catch (error) {
                console.error("Error deleting application and its data:", error);
                showMessage(`Lỗi khi xóa ứng dụng: ${error.message}`, 5000);
            }
        };


        // --- LOGIC CHO THÙNG RÁC ---

        const softDeleteVersion = async () => {
            if (!userId) return showMessage('Vui lòng đăng nhập.', 3000);
            if (!currentAppId) return showMessage('Vui lòng chọn một ứng dụng.', 3000);
            if (!currentVersionId) return showMessage('Vui lòng chọn một phiên bản để xóa.', 3000);

            if (!confirm('Bạn có chắc chắn muốn chuyển phiên bản này vào thùng rác? Bạn có thể khôi phục nó sau này từ mục "Phiên bản đã xóa".')) {
                return;
            }

            try {
                const versionRef = doc(db, `users/${userId}/applications/${currentAppId}/versions/${currentVersionId}`);
                await updateDoc(versionRef, {
                    deleted: true,
                    deletedAt: serverTimestamp()
                });
                
                showMessage('Phiên bản đã được chuyển vào thùng rác!');
                currentVersionId = null;
                mainCodeEditor.textContent = '';
                applyHighlighting();
                toggleEditorPlaceholder();
                elements.fileNameInput.value = '';
                elements.newVersionNotesInput.value = ''; // Clear new version notes
                elements.versionNotesInput.value = ''; // Clear selected version notes
                elements.versionNotesInput.disabled = true; // Disable it
                elements.editVersionNotesBtn.classList.remove('hidden'); // Show edit
                elements.saveEditedVersionNotesBtn.classList.add('hidden'); // Hide save
                elements.aiPromptInput.value = '';
                elements.aiExplanationBox.innerHTML = '<p class="text-gray-500">Phần giải thích của AI sẽ xuất hiện ở đây...</p>';
                elements.versionFilesList.innerHTML = '<div class="text-gray-500 text-center py-2">Chọn một phiên bản để xem các tệp của nó.</div>';
                chat = null;

                loadVersions(currentAppId);
            } catch (error) {
                console.error("Error soft deleting version:", error);
                showMessage(`Lỗi khi chuyển phiên bản vào thùng rác: ${error.message}`, 5000);
            }
        };

        const showDeletedVersionsModal = () => {
            if (!userId || !currentAppId) {
                return showMessage('Vui lòng chọn một ứng dụng để xem các phiên bản đã xóa.', 3000);
            }
            elements.deletedVersionsModal.classList.remove('hidden');
            loadDeletedVersions();
        };

        const closeDeletedVersionsModal = () => {
            elements.deletedVersionsModal.classList.add('hidden');
            elements.deletedVersionsList.innerHTML = '<div class="text-gray-500 text-center py-4">Đang tải các phiên bản đã xóa...</div>';
        };

        const loadDeletedVersions = () => {
            if (!userId || !currentAppId) return;
            const q = query(getCollections.versions(currentAppId), where('deleted', '==', true), orderBy('deletedAt', 'desc'));
            onSnapshot(q, (snapshot) => {
                elements.deletedVersionsList.innerHTML = '';
                if (snapshot.empty) {
                    elements.deletedVersionsList.innerHTML = '<div class="text-gray-500 text-center py-4">Thùng rác trống.</div>';
                    return;
                }
                const fragment = document.createDocumentFragment();
                snapshot.forEach(doc => {
                    const version = doc.data();
                    const versionItem = document.createElement('div');
                    versionItem.className = 'bg-gray-100 p-3 rounded-lg shadow-sm flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 mb-2';
                    const deletedAtDate = version.deletedAt ? new Date(version.deletedAt.toDate()).toLocaleString() : 'N/A';
                    
                    versionItem.innerHTML = `
                        <div>
                            <p class="font-medium text-gray-700">Phiên bản: ${version.versionIndex || 'N/A'}</p>
                            <p class="text-sm text-gray-500">${version.notes || 'Không có ghi chú'}</p>
                            <p class="text-xs text-gray-400">Đã xóa vào: ${deletedAtDate}</p>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-2 mt-2 sm:mt-0">
                            <button class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold py-1 px-3 rounded-md transition duration-300 restore-btn shadow-md">Khôi phục</button>
                            <button class="bg-red-600 hover:bg-red-700 text-white text-sm font-bold py-1 px-3 rounded-md transition duration-300 permanent-delete-btn shadow-md">Xóa vĩnh viễn</button>
                        </div>
                    `;
                    fragment.appendChild(versionItem);
                });
                elements.deletedVersionsList.appendChild(fragment);
            });
        };

        const restoreVersion = async (appId, versionId) => {
            if (!userId || !appId || !versionId) return;

            if (!confirm('Bạn có chắc chắn muốn khôi phục phiên bản này?')) {
                return;
            }

            try {
                const versionRef = doc(db, `users/${userId}/applications/${appId}/versions/${versionId}`);
                await updateDoc(versionRef, {
                    deleted: false,
                    deletedAt: null
                });
                showMessage('Phiên bản đã được khôi phục thành công!');
            } catch (error) {
                console.error("Error restoring version:", error);
                showMessage(`Lỗi khi khôi phục phiên bản: ${error.message}`, 5000);
            }
        };

        const permanentDeleteVersion = async (appId, versionId) => {
            if (!userId || !appId || !versionId) return;

            if (!confirm('CẢNH BÁO: Bạn có chắc chắn muốn XÓA VĨNH VIỄN phiên bản này? Hành động này không thể hoàn tác và sẽ xóa tất cả các tệp liên quan đến phiên bản này.')) {
                return;
            }

            try {
                const filesSnapshot = await getDocs(getCollections.files(appId, versionId));
                const deleteFilePromises = [];
                filesSnapshot.forEach((fileDoc) => {
                    deleteFilePromises.push(deleteDoc(fileDoc.ref));
                });
                await Promise.all(deleteFilePromises);

                await deleteDoc(doc(db, `users/${userId}/applications/${appId}/versions/${versionId}`));
                
                showMessage('Phiên bản và các tệp của nó đã được xóa vĩnh viễn!');
            } catch (error) {
                console.error("Error permanently deleting version:", error);
                showMessage(`Lỗi khi xóa vĩnh viễn phiên bản: ${error.message}`, 5000);
            }
        };


        // --- Gắn các sự kiện (sử dụng Event Delegation khi có thể) ---
        elements.loginBtn.addEventListener('click', () => handleAuth(false));
        elements.registerBtn.addEventListener('click', () => handleAuth(true));
        elements.logoutBtn.addEventListener('click', handleLogout);

        elements.addNewAppBtn.addEventListener('click', showAddNewAppModal);
        elements.confirmNewAppBtn.addEventListener('click', addNewApplication);
        elements.cancelNewAppBtn.addEventListener('click', hideAddNewAppModal);
        elements.saveVersionBtn.addEventListener('click', saveVersion);
        elements.sendToAIButton.addEventListener('click', callAI);
        elements.copyBtn.addEventListener('click', copyCode); // Now this button is on the editor section
        elements.previewBtn.addEventListener('click', showPreview);
        elements.closePreviewBtn.addEventListener('click', closePreview);
        elements.softDeleteVersionBtn.addEventListener('click', softDeleteVersion);
        elements.showDeletedVersionsBtn.addEventListener('click', showDeletedVersionsModal);
        elements.closeDeletedVersionsModalBtn.addEventListener('click', closeDeletedVersionsModal);

        // NEW: Event listeners for preview mode buttons
        elements.mobileViewBtn.addEventListener('click', () => setPreviewMode('mobile'));
        elements.desktopViewBtn.addEventListener('click', () => setPreviewMode('desktop'));

        // NEW: Event listeners for editing selected version notes
        elements.editVersionNotesBtn.addEventListener('click', editSelectedVersionNotes);
        elements.saveEditedVersionNotesBtn.addEventListener('click', saveEditedVersionNotes);

        // NEW: Event listeners for edit app modal
        elements.confirmEditAppBtn.addEventListener('click', saveEditedApplicationName);
        elements.cancelEditAppBtn.addEventListener('click', hideEditAppModal);

        // NEW: Event listener for AI suggestions toggle button
        elements.toggleAiSuggestionsBtn.addEventListener('click', toggleAiSuggestions);


        elements.searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredApps = allApps.filter(app => app.name.toLowerCase().includes(searchTerm));
            renderApplications(filteredApps);
        });

        // Event delegation for applications list
        elements.applicationsList.addEventListener('click', (e) => {
            const appItem = e.target.closest('.list-item');
            if (!appItem) return; // Clicked outside a list item

            const appId = appItem.dataset.appId;
            const appName = appItem.dataset.appName;

            if (e.target.classList.contains('edit-app-btn')) {
                e.stopPropagation(); // Prevent selecting the app
                showEditAppModal(appId, appName);
            } else if (e.target.classList.contains('delete-app-btn')) {
                e.stopPropagation(); // Prevent selecting the app
                deleteApplicationCascade(appId);
            } else {
                // Only select the app if not clicking on the buttons
                selectApplication(appId, appName);
            }
        });

        // Event delegation for versions list
        elements.versionsList.addEventListener('click', (e) => {
            const versionItem = e.target.closest('.list-item');
            if (versionItem && versionItem.dataset.versionId && currentAppId) {
                selectVersion(currentAppId, versionItem.dataset.versionId);
            }
        });

        // Event delegation for version files list
        elements.versionFilesList.addEventListener('click', (e) => {
            const fileItem = e.target.closest('.list-item');
            if (fileItem && fileItem.dataset.filename) {
                loadFileIntoEditor(fileItem.dataset.filename);
            }
        });

        // Event delegation for deleted versions modal buttons
        elements.deletedVersionsList.addEventListener('click', (e) => {
            if (e.target.classList.contains('restore-btn') && currentAppId) {
                restoreVersion(currentAppId, e.target.dataset.versionId);
            } else if (e.target.classList.contains('permanent-delete-btn') && currentAppId) {
                permanentDeleteVersion(currentAppId, e.target.dataset.versionId);
            }
        });

        // Event delegation for AI prompt suggestions
        elements.aiPromptSuggestionsContainer.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (button && button.dataset.prompt) {
                elements.aiPromptInput.value = button.dataset.prompt;
                elements.aiPromptInput.focus();
            }
        });

        // Gắn sự kiện cho trình soạn thảo mới
        mainCodeEditor.addEventListener('input', () => {
            applyHighlighting();
            toggleEditorPlaceholder();
        });
        mainCodeEditor.addEventListener('focus', () => {
            elements.editorPlaceholder.style.display = 'none';
        });
        mainCodeEditor.addEventListener('blur', () => {
            toggleEditorPlaceholder();
        });

        // Xử lý phím Tab trong contenteditable
        mainCodeEditor.addEventListener('keydown', (e) => {
            if (e.key === 'Tab') {
                e.preventDefault();
                const selection = window.getSelection();
                const range = selection.getRangeAt(0);
                
                const tabNode = document.createTextNode('\t');
                range.insertNode(tabNode);
                
                range.setStartAfter(tabNode);
                range.setEndAfter(tabNode);
                selection.removeAllRanges();
                selection.addRange(range);

                applyHighlighting();
                toggleEditorPlaceholder();
            }
        });

        // Initial calls
        toggleEditorPlaceholder();
        renderAiPromptSuggestions();
    </script>
</body>
</html>
